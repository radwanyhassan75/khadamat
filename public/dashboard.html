<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم - المكتب الرقمي</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <script type="module" src="auth.js"></script>

    <style>
        :root { /* ... نفس كود الـ CSS الذي لديك ... */ }
        body { font-family: 'Cairo', sans-serif; margin: 0; background-color: #f8f9fa; direction: rtl; }
        .main-header { /* ... */ } .navbar { /* ... */ } .btn { /* ... */ }
        .dashboard-wrapper { max-width: 1200px; margin: 40px auto; padding: 0 20px; }
        .dashboard-layout { display: grid; grid-template-columns: 300px 1fr; gap: 30px; align-items: flex-start; }
        .sidebar { background-color: white; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.07); padding: 25px; position: sticky; top: 120px; }
        .sidebar-header { text-align: center; margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
        .avatar-wrapper img { width: 120px; height: 120px; border-radius: 50%; border: 4px solid #0056b3; object-fit: cover; }
        .sidebar-header h3 { margin: 10px 0 0; }
        .sidebar-nav ul { list-style: none; padding: 0; margin: 0; }
        .sidebar-nav a { display: flex; align-items: center; gap: 15px; padding: 15px; color: #555; text-decoration: none; border-radius: 12px; transition: all 0.3s ease; font-weight: 700; margin-bottom: 8px; cursor: pointer; }
        .sidebar-nav a.active, .sidebar-nav a:hover { background-color: #0056b3; color: white; transform: translateX(-5px); }
        .content-pane { display: none; } .content-pane.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.07); margin-bottom: 20px; }
        .card h2 { border-bottom: 2px solid #0056b3; padding-bottom: 15px; margin-top: 0; }
        .form-group { margin-bottom: 20px; } .form-group label { display: block; margin-bottom: 8px; font-weight: 700; }
        .form-group input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        table { width: 100%; border-collapse: collapse; } th, td { padding: 15px; text-align: right; border-bottom: 1px solid #eee; }
        .status { padding: 5px 10px; border-radius: 20px; font-weight: 700; font-size: 0.9rem; }
        .status.completed { background-color: #d1e7dd; color: #0f5132; }
        .status.pending { background-color: #fff3cd; color: #664d03; }
        #delete-account-btn { background-color: #dc3545; color: white; }
    </style>
</head>
<body>
    <header class="main-header">
        <nav class="navbar">
            <a href="index.html" class="navbar-logo"><img src="https://github.com/radwanyhassan75/logo.png/blob/main/20832c91-c5a0-4bb1-a95f-b8c8bd097d7a-removebg-preview.png?raw=true" alt="شعار المكتب الرقمي" style="height: 60px;"></a>
            <div id="navbar-actions" class="navbar-actions"></div>
        </nav>
    </header>

    <main class="dashboard-wrapper">
        <div class="dashboard-layout">
            <aside class="sidebar">
                <div class="sidebar-header">
                    <div class="avatar-wrapper"><img src="https://placehold.co/150x150" alt="صورة المستخدم" id="sidebar-user-avatar"></div>
                    <h3 id="sidebar-user-name">...</h3>
                </div>
                <nav class="sidebar-nav">
                    <ul>
                        <li><a data-target="profile" class="active"><i class="fas fa-user-circle"></i> ملفي الشخصي</a></li>
                        <li><a data-target="orders"><i class="fas fa-list-alt"></i> طلباتي</a></li>
                        <li><a data-target="support"><i class="fas fa-headset"></i> تواصل معنا</a></li>
                        <li><a data-target="account"><i class="fas fa-user-cog"></i> إعدادات الحساب</a></li>
                    </ul>
                </nav>
            </aside>
            <div class="main-content">
                <div id="profile" class="content-pane active">
                    <div class="card">
                        <h2>تعديل الملف الشخصي</h2>
                        <form id="profile-form" class="form-group">
                            <div class="form-group"><label for="full_name">الاسم الكامل</label><input type="text" id="full_name"></div>
                            <div class="form-group"><label for="phone_number">رقم الهاتف</label><input type="tel" id="phone_number"></div>
                            <button type="submit" class="btn btn-primary">حفظ التغييرات</button>
                        </form>
                    </div>
                </div>
                <div id="orders" class="content-pane">
                    <div class="card">
                        <h2>طلباتي</h2>
                        <table id="orders-table">
                            <thead><tr><th>اسم الخدمة</th><th>الحالة</th><th>تاريخ الطلب</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <div id="support" class="content-pane">
                    <div class="card">
                        <h2>تواصل معنا</h2>
                        <p>إذا واجهت أي مشكلة، لا تتردد في التواصل معنا عبر البريد الإلكتروني:</p>
                        <a href="mailto:support@khadamatmaroc.co.uk" style="font-weight: bold;">support@khadamatmaroc.co.uk</a>
                    </div>
                </div>
                <div id="account" class="content-pane">
                    <div class="card">
                        <h2>إعدادات الحساب</h2>
                        <p>لحذف حسابك بشكل نهائي، اضغط على الزر أدناه. هذا الإجراء لا يمكن التراجع عنه.</p>
                        <button id="delete-account-btn" class="btn">حذف حسابي نهائياً</button>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
<script type="module">
    let currentUser = null;

    // --- تحميل وعرض البيانات ---
    async function loadUserData(user) {
        currentUser = user;
        document.getElementById('sidebar-user-name').textContent = user.user_metadata.full_name || user.email;
        document.getElementById('sidebar-user-avatar').src = user.user_metadata.avatar_url || 'https://placehold.co/150x150';

        const { data: profile, error } = await supabase.from('users').select('full_name, phone_number').eq('id', user.id).single();
        
        if (profile) {
            document.getElementById('full_name').value = profile.full_name || '';
            document.getElementById('phone_number').value = profile.phone_number || '';
        }
    }

    async function loadOrders(userId) {
        const { data: orders, error } = await supabase.from('orders').select('*').eq('user_id', userId);
        const tableBody = document.getElementById('orders-table').querySelector('tbody');
        tableBody.innerHTML = ''; // تفريغ الجدول قبل ملئه
        if (orders && orders.length > 0) {
            orders.forEach(order => {
                const statusClass = order.status === 'مكتمل' ? 'completed' : 'pending';
                tableBody.innerHTML += `
                    <tr>
                        <td>${order.service_name}</td>
                        <td><span class="status ${statusClass}">${order.status}</span></td>
                        <td>${new Date(order.created_at).toLocaleDateString()}</td>
                    </tr>
                `;
            });
        } else {
            tableBody.innerHTML = '<tr><td colspan="3">لا توجد لديك طلبات حالياً.</td></tr>';
        }
    }

    // --- التفاعل مع النماذج والأزرار ---
    document.getElementById('profile-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const newName = document.getElementById('full_name').value;
        const newPhone = document.getElementById('phone_number').value;

        // 1. تحديث الجدول العام
        const { error: profileError } = await supabase.from('users').update({ full_name: newName, phone_number: newPhone }).eq('id', currentUser.id);
        
        // 2. تحديث بيانات المصادقة
        const { error: authError } = await supabase.auth.updateUser({ data: { full_name: newName } });

        if (profileError || authError) {
            alert('حدث خطأ أثناء تحديث البيانات.');
        } else {
            alert('تم تحديث بياناتك بنجاح!');
            document.getElementById('sidebar-user-name').textContent = newName; // تحديث الاسم في الشريط الجانبي
        }
    });

    document.getElementById('delete-account-btn').addEventListener('click', async () => {
        if (confirm('هل أنت متأكد من رغبتك في حذف حسابك نهائياً؟ لا يمكن التراجع عن هذا الإجراء.')) {
            // لحذف الحساب، يجب استدعاء Edge Function بصلاحيات المسؤول
            const { error } = await supabase.functions.invoke('delete-user');
            if (error) {
                alert('حدث خطأ أثناء حذف الحساب: ' + error.message);
            } else {
                alert('تم حذف حسابك بنجاح. سنقوم بتسجيل خروجك الآن.');
                await supabase.auth.signOut();
                window.location.href = '/index.html';
            }
        }
    });

    // --- التنقل بين الأقسام ---
    const navLinks = document.querySelectorAll('.sidebar-nav a[data-target]');
    const contentPanes = document.querySelectorAll('.main-content .content-pane');
    navLinks.forEach(link => {
        link.addEventListener('click', e => {
            e.preventDefault();
            const targetId = link.getAttribute('data-target');
            
            navLinks.forEach(item => item.classList.remove('active'));
            contentPanes.forEach(pane => pane.classList.remove('active'));
            
            link.classList.add('active');
            document.getElementById(targetId).classList.add('active');

            if (targetId === 'orders') {
                loadOrders(currentUser.id);
            }
        });
    });

    // --- نقطة البداية ---
    document.addEventListener('DOMContentLoaded', async () => {
        const { data: { session } } = await supabase.auth.getSession();
        if (session) {
            loadUserData(session.user);
        }
    });
</script>
</body>
</html>