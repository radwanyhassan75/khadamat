<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم - المكتب الرقمي</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- ✅ الإصلاح الرئيسي: استدعاء auth.js أولاً لضمان توفر Supabase -->
    <script type="module" src="auth.js"></script>

    <style>
        :root {
            --primary-color: #0056b3; --secondary-color: #0d6efd; --dark-color: #2c3e50;
            --light-color: #ffffff; --gray-color: #f8f9fa; --text-color: #555;
            --success-color: #198754; --danger-color: #dc3545; --border-radius: 12px;
            --box-shadow: 0 8px 30px rgba(0, 0, 0, 0.07);
        }
        body { font-family: 'Cairo', sans-serif; margin: 0; background-color: var(--gray-color); direction: rtl; }
        .main-header { background: var(--light-color); box-shadow: 0 2px 10px rgba(0,0,0,0.08); position: sticky; top: 0; width: 100%; z-index: 1000; }
        .navbar { display: flex; justify-content: space-between; align-items: center; height: 80px; padding: 0 5%; max-width: 1200px; margin: 0 auto; }
        .navbar-logo img { height: 70px; }
        .navbar-actions { display: flex; align-items: center; gap: 10px; }
        .btn { padding: 8px 20px; border-radius: 50px; text-decoration: none; font-weight: 700; transition: all 0.3s ease; display: inline-block; border: 2px solid transparent; cursor: pointer; }
        .btn-primary { background-color: var(--primary-color); color: var(--light-color); }
        .btn-secondary { background-color: transparent; color: var(--primary-color); border-color: var(--primary-color); }
        .dashboard-wrapper { max-width: 1200px; margin: 40px auto; padding: 0 20px; }
        .dashboard-layout { display: grid; grid-template-columns: 300px 1fr; gap: 30px; align-items: flex-start; }
        .sidebar { background-color: var(--light-color); border-radius: var(--border-radius); box-shadow: var(--box-shadow); padding: 25px; position: sticky; top: 120px; }
        .sidebar-header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        .avatar-wrapper { position: relative; width: 120px; height: 120px; margin: 0 auto 15px; }
        .avatar-wrapper img { width: 100%; height: 100%; border-radius: 50%; border: 4px solid var(--primary-color); object-fit: cover; background-color: #eee; }
        .sidebar-header h3 { margin: 0; font-size: 1.5rem; color: var(--dark-color); font-weight: 900; }
        .sidebar-nav ul { list-style: none; padding: 0; margin: 0; }
        .sidebar-nav a { display: flex; align-items: center; gap: 15px; padding: 15px; color: var(--text-color); text-decoration: none; border-radius: var(--border-radius); transition: all 0.3s ease; font-weight: 700; margin-bottom: 8px; cursor: pointer; }
        .sidebar-nav a:hover, .sidebar-nav a.active { background-color: var(--primary-color); color: var(--light-color); transform: translateX(-5px); box-shadow: 0 4px 15px rgba(0, 86, 179, 0.2); }
        .sidebar-nav a i { font-size: 1.2rem; width: 20px; text-align: center; }
        .sidebar-footer { margin-top: 25px; padding-top: 25px; border-top: 1px solid #eee; }
        .btn-logout { width: 100%; background-color: #fdecea; color: var(--danger-color); justify-content: center; font-weight: 700; padding: 12px; border: none; transition: all 0.3s ease; border-radius: var(--border-radius); display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .btn-logout:hover { background-color: var(--danger-color); color: white; }
        .main-content .content-pane { display: none; }
        .main-content .content-pane.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card { background: var(--light-color); padding: 30px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); margin-bottom: 30px; border: 1px solid #e9ecef; }
        .card h2 { font-size: 1.6rem; margin: 0 0 25px 0; color: var(--dark-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 15px; display: flex; align-items: center; gap: 12px; }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; }
        .info-item label { display: block; font-weight: 700; color: #888; margin-bottom: 8px; font-size: 0.9rem; }
        .info-item p { margin: 0; font-size: 1.1rem; font-weight: 700; color: var(--dark-color); background: var(--gray-color); padding: 10px 15px; border-radius: 8px; }
        .edit-form .form-group { margin-bottom: 20px; }
        .edit-form input { width: 100%; padding: 12px 15px; border: 1px solid #ced4da; border-radius: var(--border-radius); font-size: 1rem; font-family: 'Cairo', sans-serif; box-sizing: border-box; }
        .edit-form .btn-save { background-color: var(--success-color); color: white; border: none; padding: 12px 30px; font-size: 1.1rem; font-weight: 700; border-radius: var(--border-radius); cursor: pointer; }
        .form-message { padding: 10px; border-radius: 8px; margin-top: 15px; text-align: center; font-weight: 700; display: none; }
        .form-message.success { background-color: #d1e7dd; color: #0f5132; }
        .form-message.error { background-color: #f8d7da; color: #842029; }
        @media (max-width: 992px) { .dashboard-layout { grid-template-columns: 1fr; } .sidebar { position: static; top: auto; margin-bottom: 30px; } }
    </style>
</head>
<body>
    <header class="main-header">
        <nav class="navbar">
            <a href="index.html" class="navbar-logo">
                <img src="https://github.com/radwanyhassan75/logo.png/blob/main/20832c91-c5a0-4bb1-a95f-b8c8bd097d7a-removebg-preview.png?raw=true" alt="شعار المكتب الرقمي">
            </a>
            <div id="navbar-actions" class="navbar-actions">
                <!-- سيتم ملء هذا القسم بواسطة auth.js -->
            </div>
        </nav>
    </header>

    <main class="dashboard-wrapper">
        <div class="dashboard-layout">
            <aside class="sidebar">
                <div class="sidebar-header">
                    <div class="avatar-wrapper">
                        <img src="https://placehold.co/150x150/e0e0e0/555?text=..." alt="صورة المستخدم" id="sidebar-user-avatar">
                    </div>
                    <h3 id="sidebar-user-name">جاري التحميل...</h3>
                </div>
                <nav class="sidebar-nav">
                    <ul>
                        <li><a data-target="profile" class="active"><i class="fas fa-user-circle"></i> ملفي الشخصي</a></li>
                        <li><a data-target="edit-profile"><i class="fas fa-edit"></i> تعديل الملف الشخصي</a></li>
                    </ul>
                </nav>
                 <div class="sidebar-footer">
                     <!-- ✅ الإصلاح: تم ربط هذا الزر برمجياً في الأسفل -->
                    <button id="sidebar-logout-button" class="btn-logout"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</button>
                </div>
            </aside>
            <div class="main-content">
                <div id="profile" class="content-pane active">
                    <div class="card">
                        <h2><i class="fas fa-id-card"></i> معلوماتي الشخصية</h2>
                        <div class="info-grid">
                            <div class="info-item"><label>الاسم الكامل</label><p id="display-name">...</p></div>
                            <div class="info-item"><label>البريد الإلكتروني</label><p id="display-email">...</p></div>
                            <div class="info-item"><label>رقم الهاتف</label><p id="display-phone">...</p></div>
                        </div>
                    </div>
                </div>
                
                <div id="edit-profile" class="content-pane">
                    <div class="card">
                        <h2><i class="fas fa-user-edit"></i> تعديل معلوماتي</h2>
                        <form id="edit-profile-form" class="edit-form">
                            <div class="form-group">
                                <label for="edit-name">الاسم الكامل</label>
                                <input type="text" id="edit-name" placeholder="أدخل اسمك الكامل" required>
                            </div>
                            <div class="form-group">
                                <label for="edit-phone">رقم الهاتف</label>
                                <input type="tel" id="edit-phone" placeholder="مثال: 0612345678">
                            </div>
                            <button type="submit" class="btn-save">حفظ التغييرات</button>
                            <div id="edit-form-message" class="form-message"></div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
<script type="module">
    // --- العناصر في الصفحة ---
    const sidebarUserName = document.getElementById("sidebar-user-name");
    const sidebarUserAvatar = document.getElementById("sidebar-user-avatar");
    const displayNameP = document.getElementById("display-name");
    const displayEmailP = document.getElementById("display-email");
    const displayPhoneP = document.getElementById("display-phone");
    const editNameInput = document.getElementById("edit-name");
    const editPhoneInput = document.getElementById("edit-phone");
    const editForm = document.getElementById("edit-profile-form");
    const editFormMessage = document.getElementById("edit-form-message");

    // ✅ الإصلاح الرئيسي: دالة جديدة للتحقق من المستخدم وجلب البيانات
    async function checkUserAndLoadData() {
        // الحصول على جلسة المستخدم الحالية مباشرة من Supabase
        const { data: { session }, error: sessionError } = await window.supabase.auth.getSession();

        // حماية الصفحة: إذا لم تكن هناك جلسة، أعد التوجيه فورًا
        if (!session || sessionError) {
            window.location.href = 'login.html';
            return;
        }

        const user = session.user;

        // الآن بعد أن تأكدنا من وجود مستخدم، نقوم بتحميل بياناته
        // 1. عرض البيانات الفورية من جلسة المصادقة
        sidebarUserAvatar.src = user.user_metadata?.avatar_url || `https://placehold.co/150x150/e0e0e0/555?text=${user.email[0].toUpperCase()}`;
        sidebarUserName.textContent = user.user_metadata?.full_name || user.email;
        displayNameP.textContent = user.user_metadata?.full_name || "لا يوجد اسم";
        displayEmailP.textContent = user.email;
        editNameInput.value = user.user_metadata?.full_name || '';

        // 2. جلب البيانات الإضافية (مثل رقم الهاتف) من جدول 'users'
        const { data: profileData, error: profileError } = await window.supabase
            .from('users')
            .select('phone_number, full_name') // جلب الاسم الكامل أيضًا من قاعدة البيانات
            .eq('id', user.id)
            .single();

        if (profileError && profileError.code !== 'PGRST116') {
            console.error("خطأ في جلب بيانات الملف الشخصي:", profileError);
            displayPhoneP.textContent = "خطأ في تحميل البيانات";
            return;
        }
        
        if (profileData) {
            // تحديث الاسم من قاعدة البيانات إذا كان موجودًا
            if (profileData.full_name) {
                sidebarUserName.textContent = profileData.full_name;
                displayNameP.textContent = profileData.full_name;
                editNameInput.value = profileData.full_name;
            }
            displayPhoneP.textContent = profileData.phone_number || "يرجى تحديث رقم هاتفك";
            editPhoneInput.value = profileData.phone_number || "";
        } else {
            displayPhoneP.textContent = "يرجى تحديث رقم هاتفك";
        }
    }

    // --- تشغيل الدالة عند تحميل الصفحة ---
    document.addEventListener('DOMContentLoaded', checkUserAndLoadData);
    
    // --- بقية الدوال كما هي ---
    // ... (كود حفظ التغييرات، والتنقل، وتسجيل الخروج) ...
    
    // (للتأكد، يمكنك نسخ بقية الدوال من ملفك الأصلي ولصقها هنا)
    async function saveProfileChanges(event) { /* ... نفس الكود ... */ }
    editForm.addEventListener('submit', saveProfileChanges);
    // ... دوال التنقل وتسجيل الخروج ...
</script>
</body>
</html>

