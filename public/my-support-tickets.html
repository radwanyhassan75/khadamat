<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>تذاكر الدعم - khadamatmaroc</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { font-family: 'Tajawal', sans-serif; }
        .ticket-card { transition: box-shadow 0.3s ease; }
        /* Removed @apply, use Tailwind class directly in HTML */
    </style>
</head>
<body class="bg-gray-100">

    <header class="main-header bg-white shadow-sm sticky top-0 z-50">
        <nav class="navbar container mx-auto flex justify-between items-center p-4">
            <a href="index.html" class="navbar-logo"><img src="https://khadamatmaroc.co.uk/images/logo.png" alt="شعار khadamatmaroc" class="h-14"></a>
            <ul class="nav-links hidden md:flex space-x-8 space-x-reverse font-bold">
                <li><a href="index.html" class="hover:text-blue-600">الرئيسية</a></li>
                <li><a href="services.html" class="hover:text-blue-600">الخدمات</a></li>
                <li><a href="my-orders.html" class="hover:text-blue-600">طلباتي</a></li>
            </ul>
        </nav>
    </header>

    <main class="container mx-auto p-4 md:p-8">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-extrabold text-gray-800">تذاكر الدعم الخاصة بي</h1>
            <a href="contact.html" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">فتح تذكرة جديدة</a>
        </div>
        
        <div id="tickets-container" class="space-y-6">
            <!-- Loading State -->
            <div id="loading-state" class="text-center py-10">
                <p class="text-gray-600">جاري تحميل تذاكر الدعم...</p>
            </div>
            <!-- Empty State -->
            <div id="empty-state" class="text-center py-10 bg-white rounded-xl shadow-md hidden">
                <h3 class="text-xl font-bold mb-2">لا توجد لديك تذاكر دعم بعد.</h3>
                <p class="text-gray-600">إذا كنت تواجه مشكلة، لا تتردد في فتح تذكرة جديدة.</p>
            </div>
        </div>
    </main>
    
    <footer class="main-footer bg-gray-800 text-white mt-12 p-8">
        <div class="container mx-auto text-center">
            <p>&copy; 2025 khadamatmaroc. جميع الحقوق محفوظة.</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const SUPABASE_URL = 'https://dlzmyxsycjzedhuqzvpg.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRsem15eHN5Y2p6ZWRodXF6dnBnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxNTI5ODAsImV4cCI6MjA3MTcyODk4MH0.d8Mk01dOUWyOV3wLWM2NIYFzZhN_azr9S4kOZFA6ZvA';
            const { createClient } = supabase;
            const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            
            const ticketsContainer = document.getElementById('tickets-container');
            const loadingState = document.getElementById('loading-state');
            const emptyState = document.getElementById('empty-state');

            supabaseClient.auth.onAuthStateChange(async (event, session) => {
                if (!session) {
                    window.location.href = '/login.html';
                } else {
                    await loadUserTickets(session.user);
                }
            });

            async function loadUserTickets(user) {
                try {
                    const { data: tickets, error } = await supabaseClient
                        .from('tickets')
                        .select('*')
                        .eq('email', user.email)
                        .order('created_at', { ascending: false });

                    if (error) throw error;
                    
                    loadingState.style.display = 'none';
                    if (tickets.length === 0) {
                        emptyState.style.display = 'block';
                    } else {
                        tickets.forEach(ticket => {
                            const ticketCard = createTicketCard(ticket);
                            ticketsContainer.appendChild(ticketCard);
                        });
                    }

                } catch(err) {
                    loadingState.innerHTML = `<p class="text-red-600">حدث خطأ أثناء تحميل التذاكر.</p>`;
                    console.error('Error loading tickets:', err);
                }
            }

            function createTicketCard(ticket) {
                const card = document.createElement('div');
                card.className = 'ticket-card bg-white rounded-xl shadow-md p-6 hover:shadow-lg';
                
                const statusColors = {
                    'مفتوحة': 'bg-green-100 text-green-700',
                    'قيد المعالجة': 'bg-yellow-100 text-yellow-700',
                    'مغلقة': 'bg-gray-100 text-gray-700'
                };
                const statusColor = statusColors[ticket.status] || 'bg-gray-100 text-gray-700';
                
                const ticketDate = new Date(ticket.created_at).toLocaleString('ar-MA', { dateStyle: 'long', timeStyle: 'short' });

                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm text-gray-500">رقم التذكرة: ${ticket.public_ticket_id || ticket.id}</p>
                            <h3 class="text-lg font-bold text-gray-800">${ticket.subject || 'بدون موضوع'}</h3>
                        </div>
                        <span class="text-sm font-bold px-3 py-1 rounded-full ${statusColor}">${ticket.status}</span>
                    </div>
                    <p class="text-gray-600 my-4 border-r-4 border-blue-200 pr-4">${ticket.message}</p>
                    <div class="text-sm text-gray-500 border-t pt-4">
                        <span>تاريخ الإنشاء: ${ticketDate}</span>
                    </div>
                `;
                return card;
            }
        });
    </script>
</body>
</html>
