<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إتمام الطلب - المكتب الرقمي</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
    "@type": "ListItem",
    "position": 1,
    "name": "الرئيسية",
    "item": "https://khadamatmaroc.co.uk/index.html"
  },{
    "@type": "ListItem",
    "position": 2,
    "name": "بوابة الدفع"
  }]
}
</script>

    <style>
        :root {
            --primary-color: #0056b3;
            --primary-hover-color: #004494;
            --secondary-color: #6c757d;
            --stripe-color: #6772e5;
            --dark-color: #1d2d3d;
            --light-color: #ffffff;
            --gray-color: #f8f9fa;
            --text-color: #555;
            --border-color: #dee2e6;
            --border-radius: 12px;
            --box-shadow: 0 8px 25px rgba(0, 0, 0, 0.06);
            --success-color: #198754;
            --danger-color: #dc3545;
            --info-color: #eef2ff;
        }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Cairo', sans-serif; margin: 0; background-color: var(--gray-color);
            direction: rtl; color: var(--text-color);
        }

        .main-header {
            background: var(--light-color); box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: sticky; top: 0; width: 100%; z-index: 1000;
        }
        .navbar {
            display: flex; justify-content: space-between; align-items: center;
            height: 80px; padding: 0 5%; max-width: 1200px; margin: 0 auto;
        }
        .navbar-logo img { height: 60px; transition: transform 0.3s ease; }
        .navbar-logo img:hover { transform: scale(1.05); }
        .nav-links { list-style: none; display: flex; gap: 35px; margin: 0; padding: 0; align-items: center; transition: transform 0.3s ease-in-out; }
        .nav-links a { text-decoration: none; color: var(--dark-color); font-weight: 700; font-size: 1rem; transition: color 0.3s ease; position: relative; padding-bottom: 5px; }
        .nav-links a::after { content: ''; position: absolute; width: 0; height: 2px; bottom: 0; right: 0; background-color: var(--primary-color); transition: width 0.3s ease-in-out; }
        .nav-links a:hover { color: var(--primary-color); }
        .nav-links a:hover::after { width: 100%; }
        .hamburger { display: none; cursor: pointer; font-size: 1.8rem; color: var(--dark-color); z-index: 1001; }

        .page-container { max-width: 800px; margin: 40px auto; padding: 0 20px; }
        .page-header h1 { font-size: 2.5rem; font-weight: 900; color: var(--dark-color); text-align: center; margin-bottom: 40px;}
        .card {
            background: var(--light-color); padding: 30px 40px; border-radius: var(--border-radius);
            box-shadow: var(--box-shadow); margin-bottom: 30px; border: 1px solid #e9ecef;
            animation: slideUp 0.6s ease-out;
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .card-header {
            display: flex; align-items: center; gap: 15px; color: var(--dark-color);
            font-size: 1.5rem; font-weight: 900; margin: -30px -40px 25px;
            padding: 20px 40px; border-bottom: 1px solid var(--border-color);
        }
        .card-header .step-icon {
            background-color: var(--primary-color); color: white; width: 40px; height: 40px;
            border-radius: 50%; display: inline-flex; align-items: center; justify-content: center;
            font-size: 1.2rem; flex-shrink: 0;
        }

        .form-group { margin-bottom: 25px; position: relative; }
        label { font-weight: 700; margin-bottom: 8px; display: block; color: var(--dark-color); }
        .required-star { color: var(--danger-color); }
        .input-wrapper { position: relative; }
        .input-icon { position: absolute; top: 50%; transform: translateY(-50%); right: 18px; color: #adb5bd; transition: color 0.3s ease; }
        input, textarea {
            width: 100%; padding: 14px 50px 14px 18px; border: 1px solid #ced4da;
            border-radius: 10px; font-size: 1rem; font-family: 'Cairo', sans-serif;
            box-sizing: border-box; transition: all 0.3s ease;
        }
        input:focus, textarea:focus {
            outline: none; border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(0, 86, 179, 0.15);
        }
        input:focus ~ .input-icon { color: var(--primary-color); }
        .form-group.invalid input, .form-group.invalid textarea { border-color: var(--danger-color); }
        .form-group.invalid .input-icon { color: var(--danger-color); }
        .error-message {
            color: var(--danger-color); font-size: 0.8rem; font-weight: 600;
            margin-top: 5px; display: none;
            animation: fadeIn 0.3s;
        }
        .form-group.invalid .error-message { display: block; }

        input[readonly] { background-color: #e9ecef; cursor: not-allowed; }
        .submit-btn {
            width: 100%; padding: 16px; font-size: 1.25rem; border: none;
            color: white; font-weight: bold; border-radius: 10px;
            cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .submit-btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .submit-btn.bank-transfer { background: linear-gradient(45deg, var(--success-color), #20c997); }
        .submit-btn.stripe { background: linear-gradient(45deg, var(--stripe-color), #8591ff); }
        .submit-btn:disabled { background: #adb5bd; cursor: not-allowed; }
        #form-error { display: none; background-color: #f8d7da; color: #842029; padding: 15px; border-radius: var(--border-radius); margin-top: 20px; font-weight: 700; border: 1px solid #f5c2c7; }
        
        .payment-options-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .payment-option {
            border: 2px solid var(--border-color); border-radius: var(--border-radius); padding: 20px 10px;
            cursor: pointer; transition: all 0.3s ease; text-align: center; display: flex; flex-direction: column;
            align-items: center; justify-content: center; height: 150px; background-color: var(--light-color);
        }
        .payment-option:hover { transform: translateY(-5px); box-shadow: 0 6px 18px rgba(0,0,0,0.08); border-color: var(--secondary-color); }
        .payment-option.active { border-color: var(--success-color); background-color: #f0fff8; transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .payment-option.stripe.active { border-color: var(--stripe-color); background-color: var(--info-color); }
        .payment-option img { height: auto; max-height: 65px; width: 100%; max-width: 110px; object-fit: contain; margin-bottom: 15px; }
        .payment-option span { font-weight: 700; color: var(--dark-color); font-size: 1rem; line-height: 1.3; }

        .payment-details-container, .stripe-info-box { display: none; padding: 25px; border-radius: var(--border-radius); margin-top: 20px; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .payment-details-container.active, .stripe-info-box.active { display: block; }
        .payment-details-container { background: #f8f9fa; border: 1px solid #dee2e6; }
        .stripe-info-box { background-color: var(--info-color); border-right: 6px solid var(--stripe-color); padding: 20px; }
        
        .payment-summary-box { background-color: var(--info-color); padding: 20px; border-radius: var(--border-radius); margin-bottom: 25px; border-left: 5px solid var(--primary-color); }
        .payment-summary-box h4 { margin: 0 0 15px 0; font-size: 1.2rem; color: var(--dark-color); display: flex; align-items: center; gap: 10px; }
        .summary-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #dce4ff; }
        .summary-row:last-child { border-bottom: none; }
        .summary-row span { font-weight: 600; color: #555; }
        .summary-row strong { font-weight: 700; color: var(--dark-color); font-size: 1.1rem; }
        
        .payment-instructions h5 { font-size: 1.1rem; font-weight: 800; color: var(--dark-color); margin: 25px 0 15px 0; padding-bottom: 5px; border-bottom: 2px solid var(--primary-color); display: inline-block; }
        .payment-instructions ul { list-style: none; padding-right: 20px; margin: 0 0 20px 0; }
        .payment-instructions li { position: relative; padding-right: 30px; margin-bottom: 12px; line-height: 1.7; font-size: 0.95rem; }
        .payment-instructions li::before {
            font-family: "Font Awesome 6 Free"; font-weight: 900; content: '\f100';
            position: absolute; right: 0; top: 4px; color: var(--primary-color); font-size: 1rem;
        }
        .payment-instructions .final-step { font-weight: 700; color: var(--danger-color); background-color: #fff3f3; padding: 10px; border-radius: 8px; margin-top: 25px; border-right: 4px solid var(--danger-color); }
        
        .detail-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 8px; background-color: #fff; margin-bottom: 10px; border: 1px solid #e9ecef;}
        .detail-row .label { font-weight: 700; color: #6c757d; }
        .detail-row .value { font-weight: 700; color: var(--dark-color); direction: ltr; text-align: left; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
        .copy-button { background: none; border: none; color: var(--primary-color); cursor: pointer; font-size: 1.1rem; }

        .file-drop-area { border: 2px dashed var(--border-color); border-radius: var(--border-radius); padding: 30px; text-align: center; cursor: pointer; transition: all 0.3s ease; }
        .file-drop-area.drag-over { border-color: var(--primary-color); background-color: #f0f6ff; }
        .file-drop-area .upload-icon { font-size: 2.5rem; color: var(--primary-color); margin-bottom: 15px; }
        .file-drop-area p { margin: 0; font-weight: 700; }
        .file-drop-area span { font-size: 0.9rem; color: #6c757d; }
        .file-input-hidden { display: none; }
        .file-preview-wrapper { display: none; margin-top: 15px; background-color: var(--gray-color); padding: 15px; border-radius: 10px; align-items: center; justify-content: space-between; }
        .file-preview-info { display: flex; align-items: center; gap: 15px; overflow: hidden; }
        .file-preview-thumb { width: 50px; height: 50px; object-fit: cover; border-radius: 8px; flex-shrink: 0; }
        .file-preview-icon { font-size: 2.5rem; color: var(--secondary-color); flex-shrink: 0; }
        .file-preview-name { font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .remove-file-btn { background: none; border: none; font-size: 1.2rem; color: var(--danger-color); cursor: pointer; flex-shrink: 0; margin-right: auto; }

        .legal-agreements { margin-top: 30px; padding: 20px; border-top: 1px solid var(--border-color); background-color: #fcfdff; border-radius: 10px; }
        .checkbox-group { display: flex; align-items: flex-start; gap: 15px; margin-bottom: 15px; position: relative; }
        .checkbox-group:last-child { margin-bottom: 0; }
        .checkbox-group input[type="checkbox"] { flex-shrink: 0; margin-top: 6px; appearance: none; -webkit-appearance: none; width: 1.3em; height: 1.3em; border: 2px solid #adb5bd; border-radius: 5px; cursor: pointer; transition: all 0.2s ease-in-out; position: relative; }
        .checkbox-group input[type="checkbox"]:checked { background-color: var(--primary-color); border-color: var(--primary-color); }
        .checkbox-group input[type="checkbox"]:checked::after { content: '\f00c'; font-family: "Font Awesome 6 Free"; font-weight: 900; color: white; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.8em; }
        .checkbox-group label { font-weight: normal; font-size: 0.95rem; line-height: 1.7; margin: 0; }
        .checkbox-group a { color: var(--primary-color); font-weight: 700; text-decoration: none; }
        .checkbox-group a:hover { text-decoration: underline; }
        .form-group.invalid .checkbox-group label { color: var(--danger-color); } 
        
        .main-footer { background-color: #1c2331; color: #bdc3c7; padding: 60px 5% 20px; }
        .footer-content { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 40px; margin-bottom: 40px; max-width: 1200px; margin-left: auto; margin-right: auto;}
        .footer-title { color: var(--light-color); font-size: 1.25rem; margin-bottom: 25px; font-weight: 700; position: relative; padding-bottom: 10px; }
        .footer-title::after { content: ''; position: absolute; bottom: 0; right: 0; width: 50px; height: 2px; background-color: var(--primary-color); }
        .footer-section p, .footer-section ul { line-height: 1.8; list-style: none; padding: 0; margin: 0; }
        .footer-section ul li { margin-bottom: 12px; }
        .footer-section a { color: #bdc3c7; text-decoration: none; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 8px; }
        .footer-section a:hover { color: var(--light-color); padding-right: 5px; }
        .social-links { display: flex; gap: 15px; margin-top: 20px; }
        .social-links a { font-size: 1.5rem; color: #bdc3c7; transition: color 0.3s ease; }
        .social-links a:hover { color: var(--primary-color); }
        .footer-bottom { text-align: center; border-top: 1px solid #34495e; padding-top: 20px; font-size: 0.9rem; }

        #loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center;
            z-index: 9999; flex-direction: column; gap: 20px;
        }
        #loader-overlay .spinner {
            border: 8px solid #f3f3f3; border-top: 8px solid var(--primary-color);
            border-radius: 50%; width: 60px; height: 60px;
            animation: spin 1s linear infinite;
        }
        #loader-overlay p { font-size: 1.5rem; font-weight: 700; color: var(--dark-color); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media (max-width: 768px) {
            .navbar { position: relative; }
            .hamburger { display: block; }
            .nav-links {
                position: absolute; top: 80px; right: 0;
                background: var(--light-color);
                width: 100%;
                flex-direction: column;
                gap: 0;
                box-shadow: 0 10px 15px rgba(0,0,0,0.1);
                transform: translateY(-150%);
                padding: 10px 0;
            }
            .nav-links.active { transform: translateY(0); }
            .nav-links li { width: 100%; text-align: center; }
            .nav-links a { display: block; padding: 20px; width: 100%; }
            .nav-links a::after { right: 50%; transform: translateX(50%); }

            .card { padding: 20px; }
            .card-header { padding: 15px 20px; margin: -20px -20px 20px; font-size: 1.3rem; }
        }
    </style>
</head>
<body>
    <div id="loader-overlay">
        <div class="spinner"></div>
        <p id="loader-text">جاري الإرسال...</p>
    </div>

    <header class="main-header">
        <nav class="navbar">
            <a href="index.html" class="navbar-logo">
                <img src="https://github.com/radwanyhassan75/logo.png/blob/main/20832c91-c5a0-4bb1-a95f-b8c8bd097d7a-removebg-preview.png?raw=true" alt="شعار المكتب الرقمي">
            </a>
            <ul class="nav-links" id="nav-links">
                <li><a href="index.html">الرئيسية</a></li>
                <li><a href="blog.html">المدونة</a></li>
                <li><a href="services.html">الخدمات</a></li>
                <li><a href="tracking.html">تتبع الطلب</a></li>
                <li><a href="contact.html">اتصل بنا</a></li>
            </ul>
            <div class="hamburger" id="hamburger"><i class="fas fa-bars"></i></div>
        </nav>
    </header>

    <div class="page-container">
        <header class="page-header">
            <h1>إتمام الطلب</h1>
        </header>

        <form id="payment-form" novalidate>
            <div class="card">
                <div class="card-header"><span class="step-icon"><i class="fas fa-shopping-cart"></i></span><h3>ملخص الطلب</h3></div>
                <div class="form-group"><label>الخدمة المطلوبة:</label><input type="text" id="display-service-name" readonly></div>
                <div class="form-group"><label>السعر:</label><input type="text" id="display-service-price" readonly></div>
            </div>
            
            <input type="hidden" id="form-service-name" name="serviceName">
            <input type="hidden" id="form-service-price" name="price">

            <div class="card">
                <div class="card-header"><span class="step-icon"><i class="fas fa-user"></i></span><h3>معلوماتك الشخصية</h3></div>
                <div class="form-group">
                    <label for="name">الاسم الكامل <span class="required-star">*</span></label>
                    <div class="input-wrapper"><i class="fas fa-user input-icon"></i><input type="text" name="customerName" id="name" placeholder="مثال: محمد أمين" required /></div>
                    <div class="error-message">الاسم الكامل مطلوب (حروف فقط).</div>
                </div>
                <div class="form-group">
                    <label for="email">البريد الإلكتروني <span class="required-star">*</span></label>
                    <div class="input-wrapper"><i class="fas fa-envelope input-icon"></i><input type="email" name="email" id="email" placeholder="example@mail.com" required /></div>
                    <div class="error-message">يرجى إدخال بريد إلكتروني صحيح.</div>
                </div>
                <div class="form-group">
                    <label for="phone">رقم الهاتف / واتساب <span class="required-star">*</span></label>
                    <div class="input-wrapper"><i class="fab fa-whatsapp input-icon"></i><input type="tel" name="phone" id="phone" placeholder="مثال: 0612345678" required /></div>
                    <div class="error-message">رقم هاتف مغربي صحيح مطلوب (مثل 0612345678).</div>
                </div>
                </div>

            <div class="card">
                <div class="card-header"><span class="step-icon"><i class="fas fa-pencil-alt"></i></span><h3>تفاصيل إضافية ومرفقات</h3></div>
                <div class="form-group">
                    <label for="service-details">تفاصيل الخدمة المطلوبة <span class="required-star">*</span></label>
                    <textarea name="serviceDetails" id="service-details" rows="5" required 
placeholder="يرجى تقديم كل التفاصيل لمساعدتنا على تنفيذ طلبك بدقة.

أمثلة:
- أحتاج سيرة ذاتية احترافية باللغة الإنجليزية لوظيفة مدير تسويق...
- أريد حجز موعد 'Timos' في القنصلية الإسبانية في أقرب وقت...
- أطلب كتابة رسالة شكوى رسمية لمالك العقار بخصوص..."></textarea>
                    <div class="error-message">يرجى تقديم تفاصيل طلبك.</div>
                </div>
                <div class="form-group">
                    <label for="optional-link">رابط إضافي (اختياري)</label>
                    <div class="input-wrapper"><i class="fas fa-link input-icon"></i><input type="url" name="optionalLink" id="optional-link" placeholder="https://example.com" /></div>
                </div>
                <div class="form-group">
                    <label for="attachment-file-input">إرفاق ملف (اختياري)</label>
                    <div class="file-drop-area" id="attachment-drop-area">
                        <input type="file" id="attachment-file-input" name="attachmentFile" class="file-input-hidden">
                        <i class="fas fa-cloud-upload-alt upload-icon"></i>
                        <p>اسحب وأفلت الملف هنا، أو انقر للاختيار</p>
                    </div>
                    <div class="file-preview-wrapper" id="attachment-preview-wrapper">
                        <div class="file-preview-info"></div>
                        <button type="button" class="remove-file-btn" aria-label="إزالة الملف"><i class="fas fa-times"></i></button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><span class="step-icon"><i class="fas fa-credit-card"></i></span><h3>الدفع وتأكيد الطلب</h3></div>
                <div class="form-group">
                    <label>اختر وسيلة الدفع <span class="required-star">*</span></label>
                    <div class="payment-options-grid" id="payment-options">
                        <p class="loading-text">جاري تحميل خيارات الدفع...</p>
                    </div>
                    <input type="hidden" name="paymentMethod" id="payment-method-input" required>
                    <div class="error-message">يرجى اختيار وسيلة دفع.</div>
                </div>
                
                <div id="payment-details-container" class="payment-details-container"></div>
                
                <div id="stripe-info-box" class="stripe-info-box">
                    <h4><i class="fas fa-info-circle"></i> تنبيه هام للدفع بالبطاقة</h4><p>لضمان نجاح الدفع، يجب تفعيل <strong>"مخصصات التجارة الإلكترونية" (Dotation e-commerce)</strong> على بطاقتك البنكية. تواصل مع البنك الخاص بك للتفعيل.</p>
                </div>
                
                <div class="form-group" id="receipt-upload-group" style="display: none;">
                    <label for="receipt-file-input">أرفق وصل الدفع (صورة أو PDF) <span class="required-star">*</span></label>
                     <div class="file-drop-area" id="receipt-drop-area">
                         <input type="file" id="receipt-file-input" name="receiptFile" class="file-input-hidden" accept=".png,.jpg,.jpeg,.pdf" required>
                         <i class="fas fa-receipt upload-icon"></i>
                         <p>اسحب وأفلت وصل الدفع هنا، أو انقر للاختيار</p>
                     </div>
                     <div class="file-preview-wrapper" id="receipt-preview-wrapper">
                         <div class="file-preview-info"></div>
                         <button type="button" class="remove-file-btn" aria-label="إزالة الملف"><i class="fas fa-times"></i></button>
                     </div>
                     <div class="error-message">وصل الدفع مطلوب لإتمام الطلب.</div>
                </div>
                
                <div class="legal-agreements form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="terms-agree" required>
                        <label for="terms-agree">أقر بأنني قرأت ووافقت على <a href="terms.html" target="_blank">الشروط والأحكام</a> و <a href="privacy.html" target="_blank">سياسة الخصوصية</a>.</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="data-consent" required>
                        <label for="data-consent">أوافق على جمع بياناتي الشخصية لمعالجة طلبي وفقًا للقانون 09-08.</label>
                    </div>
                    <div class="error-message">يجب الموافقة على جميع الشروط للمتابعة.</div>
                </div>

                <button type="submit" class="submit-btn" id="submit-btn" disabled><i class="fas fa-lock"></i> أكمل الحقول والموافقات المطلوبة</button>
                <div id="form-error"></div>
            </div>
        </form>
    </div>

    <footer class="main-footer">
        <div class="footer-content">
             <div class="footer-section">
                 <h3 class="footer-title">المكتب الرقمي</h3>
                 <p>منصة متكاملة لتسهيل جميع معاملاتك الإدارية والرقمية بكفاءة وموثوقية عالية في المغرب.</p>
                 <div class="social-links">
                   <a href="https://m.me/548280335029651" target="_blank" rel="noopener noreferrer" title="Facebook Messenger"><i class="fab fa-facebook-messenger"></i></a>
                   <a href="https://wa.me/212720327932" target="_blank" rel="noopener noreferrer" title="WhatsApp"><i class="fab fa-whatsapp"></i></a>
                   <a href="https://www.instagram.com/khadmatidigital/" target="_blank" rel="noopener noreferrer" title="Instagram"><i class="fab fa-instagram"></i></a>
                 </div>
             </div>
             <div class="footer-section">
                 <h3 class="footer-title">روابط مهمة</h3>
                 <ul>
                     <li><a href="services.html"><i class="fas fa-cogs"></i> جميع الخدمات</a></li>
                     <li><a href="tracking.html"><i class="fas fa-search-location"></i> تتبع طلبك</a></li>
                     <li><a href="blog.html"><i class="fas fa-newspaper"></i> المدونة</a></li>
                     <li><a href="contact.html"><i class="fas fa-headset"></i> اتصل بنا</a></li>
                 </ul>
             </div>
             <div class="footer-section">
                 <h3 class="footer-title">قانوني</h3>
                 <ul>
                     <li><a href="privacy.html"><i class="fas fa-user-shield"></i> سياسة الخصوصية</a></li>
                     <li><a href="terms.html"><i class="fas fa-file-contract"></i> الشروط والأحكام</a></li>
                     <li><a href="refund.html"><i class="fas fa-undo-alt"></i> سياسة الاسترجاع</a></li>
                 </ul>
             </div>
             <div class="footer-section">
                 <h3 class="footer-title">تواصل معنا</h3>
                 <ul>
                     <li><a href="mailto:support@khadamatmaroc.co.uk"><i class="fas fa-envelope"></i> support@khadamatmaroc.co.uk</a></li>
                     <li><a href="tel:+212720327932"><i class="fas fa-phone"></i> +212720327932</a></li>
                     <li><p><i class="fas fa-map-marker-alt"></i> الرباط، المغرب</p></li>
                 </ul>
             </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 المكتب الرقمي. جميع الحقوق محفوظة.</p>
        </div>
    </footer>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // -----------------------------------------------------------------
    // --- 1. الإعدادات والتهيئة ---
    // -----------------------------------------------------------------
    
    const IS_PRODUCTION = true;

    const SUPABASE_URL = 'https://dlzmyxsycjzedhuqzvpg.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRsem15eHN5Y2p6ZWRodXF6dnBnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxNTI5ODAsImV4cCI6MjA3MTcyODk4MH0.d8Mk01dOUWyOV3wLWM2NIYFzZhN_azr9S4kOZFA6ZvA';

    const PAYMENT_CONFIG = {
        PRODUCTION: { STRIPE_PUBLISHABLE_KEY: 'pk_live_51Rp6K4Ju30ddBm3eqv8Og0m6doq0KMWOQKuNnbwDpMVBOeeAj44HSTeGk9O3Eb96ETblaveavwk1YWVOvFpVSvo9008NBFxGeF' },
        TEST: { STRIPE_PUBLISHABLE_KEY: 'pk_test_YOUR_TEST_KEY_HERE' }
    };
    
    const currentConfig = IS_PRODUCTION ? PAYMENT_CONFIG.PRODUCTION : PAYMENT_CONFIG.TEST;
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const stripe = Stripe(currentConfig.STRIPE_PUBLISHABLE_KEY);

    let soundsReady = false;
    const selectSound = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 } }).toDestination();
    const copySound = new Tone.MembraneSynth({ pitchDecay: 0.008, octaves: 2, envelope: { attack: 0.001, decay: 0.2, sustain: 0 } }).toDestination();
    document.body.addEventListener('click', async () => { if (!soundsReady) { await Tone.start(); soundsReady = true; } }, { once: true });

    const form = document.getElementById('payment-form');
    const submitBtn = document.getElementById('submit-btn');
    const errorDiv = document.getElementById('form-error');
    const paymentOptionsContainer = document.getElementById('payment-options');
    const paymentMethodInput = document.getElementById('payment-method-input');
    const paymentDetailsContainer = document.getElementById('payment-details-container');
    const stripeInfoBox = document.getElementById('stripe-info-box');
    const receiptUploadGroup = document.getElementById('receipt-upload-group');
    const loaderOverlay = document.getElementById('loader-overlay');
    const loaderText = document.getElementById('loader-text');
    let paymentMethods = [];
    const hamburger = document.getElementById('hamburger');
    const navLinks = document.getElementById('nav-links');
    hamburger.addEventListener('click', () => navLinks.classList.toggle('active'));

    // ----------------------------------------------------
    // --- 2. منطق طرق الدفع ---
    // ----------------------------------------------------

    async function fetchPaymentMethods() {
        try {
            const { data, error } = await supabaseClient
                .from('payment_methods')
                .select('*')
                .eq('is_enabled', true)
                .order('display_order', { ascending: true });

            if (error) throw error;
            paymentMethods = data;
            renderPaymentOptions();
        } catch (error) {
            console.error("خطأ في جلب طرق الدفع:", error);
            paymentOptionsContainer.innerHTML = `<p style="color: var(--danger-color);">فشل تحميل طرق الدفع. يرجى تحديث الصفحة.</p>`;
        }
    }
    
    function renderPaymentOptions() {
        paymentOptionsContainer.innerHTML = '';
        paymentMethods.forEach(method => {
            const optionDiv = document.createElement('div');
            optionDiv.className = `payment-option ${method.id}`;
            optionDiv.dataset.method = method.id;
            optionDiv.innerHTML = `<img src="${method.logo_url}" alt="${method.name}"><span>${method.name}</span>`;
            optionDiv.addEventListener('click', () => selectPaymentMethod(method.id));
            paymentOptionsContainer.appendChild(optionDiv);
        });
    }

    function selectPaymentMethod(selectedMethodId) {
        if (soundsReady) selectSound.triggerAttackRelease("C5", "8n");
        
        document.querySelectorAll('.payment-option').forEach(opt => {
            opt.classList.toggle('active', opt.dataset.method === selectedMethodId);
        });

        const selectedMethod = paymentMethods.find(m => m.id === selectedMethodId);
        paymentMethodInput.value = selectedMethod.name;

        const isBankTransfer = selectedMethodId !== 'stripe';
        
        receiptUploadGroup.style.display = isBankTransfer ? 'block' : 'none';
        document.getElementById('receipt-file-input').required = isBankTransfer;
        paymentDetailsContainer.classList.toggle('active', isBankTransfer);
        stripeInfoBox.classList.toggle('active', !isBankTransfer);
        
        if (isBankTransfer) {
            const serviceName = document.getElementById('display-service-name').value;
            const servicePrice = document.getElementById('display-service-price').value;
            renderPaymentDetails(selectedMethod, serviceName, servicePrice);
        }
        
        validateForm();
    }

    function renderPaymentDetails(method, serviceName, servicePrice) {
        if (!method || !method.details) {
            paymentDetailsContainer.innerHTML = '<p>تفاصيل الدفع غير متاحة حالياً لهذه الطريقة.</p>';
            return;
        }

        const beneficiary = method.details.beneficiary || 'اسم المستفيد';
        let detailsHtml = `
            <div class="payment-summary-box">
                <h4><i class="fas fa-file-invoice"></i> ملخص الدفع المطلوب</h4>
                <div class="summary-row"><span>الخدمة:</span><strong>${serviceName}</strong></div>
                <div class="summary-row"><span>المبلغ للدفع:</span><strong>${servicePrice}</strong></div>
                <div class="summary-row"><span>الوسيلة المختارة:</span><strong>${method.name}</strong></div>
            </div>
            <div class="payment-instructions">
                <h5><i class="fas fa-mobile-alt"></i> الطريقة الأولى: عبر تطبيقك البنكي</h5>
                <ul>
                    <li>افتح تطبيق البنك الخاص بك واختر "تحويل الأموال" (Virement).</li>
                    <li>أضف المستفيد الجديد باستخدام البيانات التالية.</li>
                    <li>أدخل المبلغ المطلوب واسمك الكامل في خانة "السبب" أو "Motif".</li>
                    <li>أكمل التحويل واحفظ لقطة شاشة (Screenshot) لوصل الدفع.</li>
                </ul>
                <h5><i class="fas fa-university"></i> الطريقة الثانية: في وكالة بنكية أو وكالة تحويل أموال</h5>
                <ul>
                    <li>توجه إلى أقرب فرع لبنك المستفيد أو وكالة (مثل وفاكاش، كاش بلوس).</li>
                    <li>اطلب إجراء تحويل أو إيداع وقدم لهم بيانات حساب المستفيد أدناه.</li>
                    <li>احتفظ بالوصل الورقي الذي ستحصل عليه وقم بتصويره بشكل واضح.</li>
                </ul>
                <h5 style="margin-top: 25px;">بيانات حساب المستفيد</h5>
                <div class="details-box">
        `;

        detailsHtml += createDetailRow('اسم المستفيد', beneficiary);
        if (method.details.phone) detailsHtml += createDetailRow('رقم الهاتف', method.details.phone);
        if (method.details.rib) detailsHtml += createDetailRow('رقم الحساب (RIB)', method.details.rib);
        
        detailsHtml += `
                </div>
                <p class="final-step">⚠️ هام جداً: بعد إتمام الدفع، يجب عليك إرفاق صورة واضحة لوصل الدفع في الحقل المخصص أدناه لتأكيد طلبك.</p>
            </div>
        `;
        
        paymentDetailsContainer.innerHTML = detailsHtml;
    }

    // --------------------------------------------------------------------
    // --- 3. منطق إرسال النموذج والتحقق ---
    // --------------------------------------------------------------------

    async function handleFormSubmit(e) {
        e.preventDefault();
        
        if (!validateForm(false)) {
            showError('يرجى تصحيح الأخطاء في الحقول المشار إليها باللون الأحمر.');
            form.querySelector('.invalid')?.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return;
        }
        
        showLoadingState(true);
        const selectedMethodId = document.querySelector('.payment-option.active')?.dataset.method;

        try {
            const attachmentFile = document.getElementById('attachment-file-input').files[0];
            const attachmentUrl = await uploadFile(attachmentFile, 'attachments');

            if (selectedMethodId === 'stripe') {
                showLoadingState(true, 'جاري التوجيه للدفع الآمن...');
                const stripeMetadata = {
                    customer_name: document.getElementById('name').value, phone: document.getElementById('phone').value,
                    service_details: document.getElementById('service-details').value,
                    optional_link: document.getElementById('optional-link').value || 'N/A',
                    payment_method: 'Stripe', attachment_url: attachmentUrl || ''
                };
                const { data, error } = await supabaseClient.functions.invoke('create-stripe-checkout', {
                    body: {
                        serviceName: document.getElementById('form-service-name').value,
                        price: parseFloat(document.getElementById('form-service-price').value),
                        customerEmail: document.getElementById('email').value, metadata: stripeMetadata
                    }
                });
                if (error) throw new Error('فشل إنشاء جلسة الدفع: ' + error.message);
                const { sessionId } = data;
                if (!sessionId) throw new Error('لم يتم استلام معرف جلسة الدفع.');
                const { error: stripeError } = await stripe.redirectToCheckout({ sessionId });
                if (stripeError) throw new Error('فشل التوجيه لصفحة الدفع: ' + stripeError.message);

            } else {
                const receiptFile = document.getElementById('receipt-file-input').files[0];
                const receiptUrl = await uploadFile(receiptFile, 'receipts');
                const orderData = {
                    customer_name: document.getElementById('name').value, email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value, service_name: document.getElementById('form-service-name').value,
                    price: parseFloat(document.getElementById('form-service-price').value),
                    service_details: document.getElementById('service-details').value, optional_link: document.getElementById('optional-link').value,
                    payment_method: document.getElementById('payment-method-input').value, receipt_url: receiptUrl, attachment_url: attachmentUrl,
                };
                const { data, error } = await supabaseClient.functions.invoke('submit-order', { body: orderData });
                if (error) throw error;
                window.location.href = `success.html?orderId=${data.orderId}`;
            }
        } catch (error) {
            showError('حدث خطأ. ' + error.message);
            showLoadingState(false);
        }
    }

    function validateField(input) {
        if (!input) return true;
        let isValid = true;
        let errorMessage = input.dataset.defaultError || 'هذا الحقل مطلوب.';

        if (input.offsetParent === null && !['file', 'hidden', 'checkbox'].includes(input.type)) return true;
        if (!input.required) return true;

        const value = input.value.trim();

        if (input.type === 'checkbox') {
            isValid = input.checked;
        } else if (input.type === 'file') {
            isValid = input.files.length > 0;
        } else if (value === '') {
            isValid = false;
        } else {
            switch (input.id) {
                case 'name':
                    isValid = /^[a-zA-Z\u0600-\u06FF\s\-']+$/.test(value);
                    if (!isValid) errorMessage = "الاسم يجب أن يحتوي على حروف ومسافات فقط.";
                    break;
                case 'email':
                    isValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value);
                    if (!isValid) errorMessage = "يرجى إدخال بريد إلكتروني بالصيغة الصحيحة.";
                    break;
                case 'phone':
                    isValid = /^(0[5-7])\d{8}$/.test(value);
                    if (!isValid) errorMessage = "يجب أن يكون رقم هاتف مغربي صالح (يبدأ بـ 06 أو 07 أو 05).";
                    break;
            }
        }
        
        const parentGroup = input.closest('.form-group');
        if (parentGroup) {
            parentGroup.classList.toggle('invalid', !isValid);
            const errorElement = parentGroup.querySelector('.error-message');
            if (errorElement) errorElement.textContent = errorMessage;
        }
        return isValid;
    }

    function validateForm(isSilent = false) {
        let isFormValid = true;
        form.querySelectorAll('[required]').forEach(input => {
            if (!validateField(input)) isFormValid = false;
        });

        if (isSilent) return isFormValid;

        submitBtn.disabled = !isFormValid;
        const selectedMethodId = document.querySelector('.payment-option.active')?.dataset.method;
        if (isFormValid) {
            submitBtn.innerHTML = selectedMethodId === 'stripe' ? '<i class="fab fa-stripe-s"></i> الدفع الآمن' : '<i class="fas fa-check-circle"></i> تأكيد الطلب';
            submitBtn.className = `submit-btn ${selectedMethodId === 'stripe' ? 'stripe' : 'bank-transfer'}`;
        } else {
            submitBtn.innerHTML = '<i class="fas fa-lock"></i> أكمل الحقول المطلوبة';
            submitBtn.className = 'submit-btn';
        }
        return isFormValid;
    }

    // ----------------------------------------------------
    // --- 4. دوال مساعدة ---
    // ----------------------------------------------------
    
    async function uploadFile(file, folder) {
        if (!file) return null;
        const fileExtension = file.name.split('.').pop();
        const newFileName = `${Date.now()}-${Math.random().toString(36).substring(2, 10)}.${fileExtension}`;
        const filePath = `public/${folder}/${newFileName}`;
        const { error } = await supabaseClient.storage.from('order-files').upload(filePath, file, { cacheControl: '3600', upsert: false });
        if (error) {
            console.error('خطأ في رفع الملف:', error);
            throw new Error(`فشل رفع الملف. الخطأ: ${error.message}`);
        }
        const { data } = supabaseClient.storage.from('order-files').getPublicUrl(filePath);
        return data.publicUrl;
    }
    
    function showLoadingState(isLoading, text = 'جاري الإرسال...') {
        if (isLoading) {
            loaderText.textContent = text;
            loaderOverlay.style.display = 'flex';
        } else {
            loaderOverlay.style.display = 'none';
            validateForm();
        }
    }

    function showError(message) {
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        window.scrollTo({ top: errorDiv.offsetTop - 100, behavior: 'smooth' });
    }
    
    function createDetailRow(label, value) {
        if (!value) return '';
        const id = `val-${Math.random().toString(36).substr(2, 9)}`;
        return `<div class="detail-row"><span class="label">${label}:</span><span class="value" id="${id}">${value}<button type="button" class="copy-button" onclick="copyToClipboard('${id}')"><i class="far fa-copy"></i></button></span></div>`;
    }

    window.copyToClipboard = function(elementId) {
        if (soundsReady) copySound.triggerAttackRelease("C4", "8n");
        const textElement = document.getElementById(elementId);
        if (!textElement) return;
        const nodeToCopy = textElement.cloneNode(true);
        const buttonToRemove = nodeToCopy.querySelector('button');
        if(buttonToRemove) nodeToCopy.removeChild(buttonToRemove);
        navigator.clipboard.writeText(nodeToCopy.textContent.trim()).then(() => {
            const copyButton = textElement.querySelector('button');
            if (copyButton) {
                const originalIcon = copyButton.innerHTML;
                copyButton.innerHTML = '<i class="fas fa-check" style="color: var(--success-color);"></i>';
                setTimeout(() => { copyButton.innerHTML = originalIcon; }, 2000);
            }
        });
    };

    function setupUploader(dropAreaId, fileInputId, previewWrapperId) {
        const dropArea = document.getElementById(dropAreaId);
        const fileInput = document.getElementById(fileInputId);
        const previewWrapper = document.getElementById(previewWrapperId);
        const removeBtn = previewWrapper.querySelector('.remove-file-btn');
        dropArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', () => handleFiles(fileInput.files, previewWrapper, fileInput));
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => dropArea.addEventListener(e, (ev) => { ev.preventDefault(); ev.stopPropagation(); }, false));
        ['dragenter', 'dragover'].forEach(e => dropArea.addEventListener(e, () => dropArea.classList.add('drag-over'), false));
        ['dragleave', 'drop'].forEach(e => dropArea.addEventListener(e, () => dropArea.classList.remove('drag-over'), false));
        dropArea.addEventListener('drop', (e) => handleFiles(e.dataTransfer.files, previewWrapper, fileInput), false);
        removeBtn.addEventListener('click', () => {
            fileInput.value = '';
            previewWrapper.style.display = 'none';
            validateForm();
        });
    }

    function handleFiles(files, previewWrapper, fileInput) {
        const file = files[0];
        if (!file) return;
        fileInput.files = files; 
        previewWrapper.style.display = 'flex';
        const previewInfo = previewWrapper.querySelector('.file-preview-info');
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => { previewInfo.innerHTML = `<img src="${e.target.result}" alt="${file.name}" class="file-preview-thumb"><span class="file-preview-name">${file.name}</span>`; };
            reader.readAsDataURL(file);
        } else {
            previewInfo.innerHTML = `<i class="fas fa-file-alt file-preview-icon"></i><span class="file-preview-name">${file.name}</span>`;
        }
        validateForm();
    }
    
    // ----------------------------------------------------
    // --- 5. تشغيل الصفحة ---
    // ----------------------------------------------------

    function initializePage() {
        const params = new URLSearchParams(window.location.search);
        const serviceName = decodeURIComponent(params.get('service') || 'خدمة غير محددة');
        const servicePrice = decodeURIComponent(params.get('price') || '0');

        document.getElementById('display-service-name').value = serviceName;
        document.getElementById('display-service-price').value = `${servicePrice} درهم`;
        document.getElementById('form-service-name').value = serviceName;
        document.getElementById('form-service-price').value = servicePrice;
        
        form.addEventListener('submit', handleFormSubmit);

        const nameInput = document.getElementById('name');
        const phoneInput = document.getElementById('phone');
        
        nameInput.addEventListener('input', () => {
            nameInput.value = nameInput.value.replace(/[^a-zA-Z\u0600-\u06FF\s\-']/g, '');
            validateField(nameInput);
        });

        phoneInput.addEventListener('input', () => {
            phoneInput.value = phoneInput.value.replace(/[^0-9]/g, '');
            validateField(phoneInput);
        });
        
        form.querySelectorAll('input[required], textarea[required]').forEach(input => {
            const errorElement = input.closest('.form-group')?.querySelector('.error-message');
            if (errorElement) input.dataset.defaultError = errorElement.textContent;
            input.addEventListener('input', () => validateForm());
            input.addEventListener('blur', () => validateField(input));
        });
        
        setupUploader('attachment-drop-area', 'attachment-file-input', 'attachment-preview-wrapper');
        setupUploader('receipt-drop-area', 'receipt-file-input', 'receipt-preview-wrapper');
        
        fetchPaymentMethods();
        validateForm();
    }
    
    initializePage();
});
</script>
    
</body>
</html>