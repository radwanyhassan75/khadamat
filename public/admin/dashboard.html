<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم - البيانات الحية</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-main: #f7f9fc; --bg-sidebar: #ffffff; --bg-header: #ffffff;
            --bg-card: #ffffff; --color-primary: #007bff; --color-text-main: #212529;
            --color-text-muted: #6c757d; --color-border: #dee2e6;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05); --shadow-md: 0 5px 15px rgba(0,0,0,0.08);
            --border-radius: 12px; --sidebar-width: 280px; --sidebar-width-collapsed: 90px;
            --header-height: 70px;
        }
        *, *::before, *::after { box-sizing: border-box; }
        body { margin: 0; font-family: 'Tajawal', sans-serif; background-color: var(--bg-main); color: var(--color-text-main); font-size: 16px; }
        .admin-panel, .auth-fail-message { display: none; }
        .admin-panel { display: flex; }
    </style>
</head>
<body>
    <div class="admin-panel" id="admin-panel">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header"><i class="fas fa-digital-tachograph logo-icon"></i><span class="logo-text">المكتب الرقمي</span></div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="dashboard.html" class="active"><i class="fas fa-home icon"></i><span class="nav-text">الرئيسية</span></a></li>
                    <li><a href="orders.html"><i class="fas fa-box-open icon"></i><span class="nav-text">قائمة الطلبات</span></a></li>
                    <li><a href="users.html"><i class="fas fa-users icon"></i><span class="nav-text">المستخدمين</span></a></li>
                    <li><a href="support-log.html"><i class="fas fa-headset icon"></i><span class="nav-text">تذاكر الدعم</span></a></li>
                    <li><a href="settings.html"><i class="fas fa-cog icon"></i><span class="nav-text">الإعدادات</span></a></li>
                </ul>
            </nav>
        </aside>
        <div class="content-wrapper">
             <main class="main-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="card-header"><p class="card-title">إجمالي الإيرادات</p><i class="fas fa-coins card-icon icon-revenue"></i></div>
                        <p class="card-value" id="revenue-value">...</p>
                    </div>
                    <div class="stat-card">
                        <div class="card-header"><p class="card-title">إجمالي الطلبات</p><i class="fas fa-shopping-cart card-icon icon-orders"></i></div>
                        <p class="card-value" id="orders-value">...</p>
                    </div>
                    <div class="stat-card">
                        <div class="card-header"><p class="card-title">التذاكر المفتوحة</p><i class="fas fa-life-ring card-icon icon-tickets"></i></div>
                        <p class="card-value" id="tickets-value">...</p>
                    </div>
                    <div class="stat-card">
                        <div class="card-header"><p class="card-title">إجمالي المستخدمين</p><i class="fas fa-user-plus card-icon icon-users"></i></div>
                        <p class="card-value" id="users-value">...</p>
                    </div>
                </div>
                <div class="main-grid">
                    <div class="panel"><canvas id="revenueChart"></canvas></div>
                </div>
            </main>
        </div>
    </div>
    <div id="auth-fail-message" style="text-align: center; padding-top: 50px;">فشل التحقق.</div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            function authenticate() {
                const requiredUser = "hassan";
                const requiredPass = "12345678";
                const user = prompt("اسم المستخدم:");
                const pass = prompt("كلمة المرور:");
                if (user === requiredUser && pass === requiredPass) {
                    document.getElementById('admin-panel').style.display = 'flex';
                    loadDashboardData();
                } else {
                    document.getElementById('auth-fail-message').style.display = 'block';
                }
            }

            async function loadDashboardData() {
                try {
                    // --- هذا هو الرابط الصحيح الذي سيعمل الآن ---
                    const response = await fetch('/api/dashboard-stats');

                    if (!response.ok) {
                        throw new Error(`Server error: ${response.status}`);
                    }
                    const data = await response.json();

                    document.getElementById('revenue-value').textContent = `${data.totalRevenue.toLocaleString()} د.م.`;
                    document.getElementById('orders-value').textContent = data.totalOrders.toLocaleString();
                    document.getElementById('tickets-value').textContent = data.openTickets.toLocaleString();
                    document.getElementById('users-value').textContent = data.totalUsers.toLocaleString();

                    const revenueChartElement = document.getElementById('revenueChart').getContext('2d');
                    new Chart(revenueChartElement, {
                        type: 'line',
                        data: {
                            labels: data.chart.labels,
                            datasets: [{
                                label: 'الإيرادات',
                                data: data.chart.data,
                                borderColor: '#007bff',
                                fill: false
                            }]
                        }
                    });
                } catch (error) {
                    console.error("Fetch error:", error);
                    alert("فشل تحميل البيانات من الخادم.");
                }
            }

            authenticate();
        });
    </script>
</body>
</html>