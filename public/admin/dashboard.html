<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة تحكم المدير - طلبات العملاء</title>
  <style>
    body {
      font-family: "Tajawal", sans-serif;
      background: #f4f6f8;
      margin: 0;
      padding: 20px;
      direction: rtl;
      color: #333;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
      color: #007bff;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: 12px 15px;
      border-bottom: 1px solid #ddd;
      text-align: center;
      font-size: 14px;
    }
    th {
      background-color: #007bff;
      color: white;
      font-weight: 600;
    }
    tr:hover {
      background-color: #f1f1f1;
    }
    select, input[type="text"] {
      width: 100%;
      padding: 6px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 13px;
    }
    button {
      padding: 6px 12px;
      margin: 2px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 13px;
      transition: background-color 0.3s ease;
    }
    button.update-btn {
      background-color: #28a745;
      color: white;
    }
    button.update-btn:hover {
      background-color: #218838;
    }
    button.delete-btn {
      background-color: #dc3545;
      color: white;
    }
    button.delete-btn:hover {
      background-color: #c82333;
    }
    #message {
      margin: 15px 0;
      padding: 10px;
      border-radius: 5px;
      display: none;
      font-weight: bold;
    }
    #message.success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    #message.error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
  </style>
</head>
<body>

  <h1>لوحة تحكم المدير - إدارة الطلبات</h1>

  <div id="message"></div>

  <table id="orders-table">
    <thead>
      <tr>
        <th>رقم الطلب</th>
        <th>اسم الزبون</th>
        <th>البريد الإلكتروني</th>
        <th>الخدمة</th>
        <th>الحالة</th>
        <th>طريقة الدفع</th>
        <th>المبلغ المدفوع</th>
        <th>رقم الهاتف</th>
        <th>تفاصيل الخدمة</th>
        <th>رابط الخدمة</th>
        <th>تاريخ الإنشاء</th>
        <th>تحديث</th>
        <th>حذف</th>
      </tr>
    </thead>
    <tbody id="orders-body">
      <tr><td colspan="13">جارٍ تحميل الطلبات...</td></tr>
    </tbody>
  </table>

  <script>
    const API_URL = "https://orders-worker.radwanyhassan75.workers.dev/orders";

    const ordersBody = document.getElementById('orders-body');
    const messageDiv = document.getElementById('message');

    // عرض رسالة (نجاح أو خطأ)
    function showMessage(text, type='success') {
      messageDiv.textContent = text;
      messageDiv.className = type === 'success' ? 'success' : 'error';
      messageDiv.style.display = 'block';
      setTimeout(() => {
        messageDiv.style.display = 'none';
      }, 4000);
    }

    // جلب وعرض الطلبات في الجدول
    async function fetchOrders() {
      ordersBody.innerHTML = '<tr><td colspan="13">جارٍ تحميل الطلبات...</td></tr>';
      try {
        const response = await fetch(API_URL, { headers: { Accept: 'application/json' } });
        if (!response.ok) throw new Error(`فشل جلب الطلبات (رمز: ${response.status})`);

        const orders = await response.json();
        if (!Array.isArray(orders) || orders.length === 0) {
          ordersBody.innerHTML = '<tr><td colspan="13">لا توجد طلبات حتى الآن.</td></tr>';
          return;
        }

        // بناء الصفوف مع الحقول والقوائم المنسدلة للتعديل
        ordersBody.innerHTML = '';
        orders.forEach(order => {
          const tr = document.createElement('tr');

          tr.innerHTML = `
            <td>${order.id || '---'}</td>
            <td>${order.customerName || ''}</td>
            <td>${order.email || ''}</td>
            <td>${order.serviceName || ''}</td>
            <td>
              <select data-id="${order.id}" class="status-select">
                <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>قيد الانتظار</option>
                <option value="processing" ${order.status === 'processing' ? 'selected' : ''}>قيد المعالجة</option>
                <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>تمت المعالجة</option>
                <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>ملغي</option>
              </select>
            </td>
            <td>
              <select data-id="${order.id}" class="payment-method-select">
                <option value="" ${!order.paymentMethod ? 'selected' : ''}>غير محدد</option>
                <option value="CashPlus" ${order.paymentMethod === 'CashPlus' ? 'selected' : ''}>كاش بلس</option>
                <option value="Orange Money" ${order.paymentMethod === 'Orange Money' ? 'selected' : ''}>أورانج موني</option>
                <option value="BMCE" ${order.paymentMethod === 'BMCE' ? 'selected' : ''}>BMCE</option>
                <option value="CIH" ${order.paymentMethod === 'CIH' ? 'selected' : ''}>CIH</option>
                <option value="Attijariwafa" ${order.paymentMethod === 'Attijariwafa' ? 'selected' : ''}>التجاري وفا</option>
                <option value="SOGE" ${order.paymentMethod === 'SOGE' ? 'selected' : ''}>SOGE</option>
              </select>
            </td>
            <td>${order.paymentAmount || order.price || 0}</td>
            <td>${order.phone || ''}</td>
            <td><textarea readonly rows="2" style="width:100%;font-size:12px;">${order.serviceDetails || ''}</textarea></td>
            <td>${order.serviceLink ? `<a href="${order.serviceLink}" target="_blank">رابط الخدمة</a>` : ''}</td>
            <td>${new Date(order.createdAt || order.created_at).toLocaleString('ar-MA')}</td>
            <td><button class="update-btn" data-id="${order.id}">تحديث</button></td>
            <td><button class="delete-btn" data-id="${order.id}">حذف</button></td>
          `;
          ordersBody.appendChild(tr);
        });

        // إضافة الأحداث للأزرار والقوائم المنسدلة
        document.querySelectorAll('.update-btn').forEach(btn => {
          btn.addEventListener('click', updateOrder);
        });

        document.querySelectorAll('.delete-btn').forEach(btn => {
          btn.addEventListener('click', deleteOrder);
        });

      } catch (error) {
        ordersBody.innerHTML = `<tr><td colspan="13">خطأ: ${error.message}</td></tr>`;
      }
    }

    // تحديث طلب معين (PUT)
    async function updateOrder(event) {
      const id = event.target.dataset.id;
      const status = document.querySelector(`.status-select[data-id="${id}"]`).value;
      const paymentMethod = document.querySelector(`.payment-method-select[data-id="${id}"]`).value;

      try {
        const response = await fetch(`${API_URL}/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ status, payment_method: paymentMethod }),
        });

        if (!response.ok) {
          const err = await response.json().catch(() => ({}));
          throw new Error(err.error || 'خطأ في تحديث الطلب');
        }
        showMessage(`تم تحديث الطلب رقم #${id} بنجاح.`, 'success');
        fetchOrders(); // تحديث الجدول
      } catch (error) {
        showMessage(`خطأ: ${error.message}`, 'error');
      }
    }

    // حذف طلب (DELETE)
    async function deleteOrder(event) {
      const id = event.target.dataset.id;
      if (!confirm(`هل أنت متأكد من حذف الطلب رقم #${id}؟`)) return;

      try {
        const response = await fetch(`${API_URL}/${id}`, {
          method: "DELETE"
        });
        if (!response.ok) {
          const err = await response.json().catch(() => ({}));
          throw new Error(err.error || 'خطأ في حذف الطلب');
        }
        showMessage(`تم حذف الطلب رقم #${id} بنجاح.`, 'success');
        fetchOrders(); // تحديث الجدول
      } catch (error) {
        showMessage(`خطأ: ${error.message}`, 'error');
      }
    }

    // تحميل الطلبات عند فتح الصفحة
    fetchOrders();
  </script>
</body>
</html>
