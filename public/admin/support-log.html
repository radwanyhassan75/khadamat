<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>سجل الدعم - لوحة تحكم خدماتك</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Cairo', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #a8a8a8; border-radius: 4px; }
        .message { max-width: 80%; }
        .message.user { float: right; clear: both; }
        .message.admin { float: left; clear: both; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Main Dashboard Content -->
    <div id="dashboard-content" class="h-screen bg-gray-100 md:flex md:flex-row-reverse">
        <!-- Sidebar -->
        <aside class="flex flex-col w-64 bg-white shadow-lg">
            <div class="flex items-center justify-center h-20 shadow-md">
                <h1 class="text-2xl font-bold text-indigo-600">لوحة التحكم</h1>
            </div>
            <nav class="flex-1 px-4 py-8 space-y-2">
                <a href="dashboard.html" class="flex items-center px-4 py-2 text-gray-700 hover:bg-indigo-100 rounded-md"><i data-lucide="layout-dashboard" class="w-5 h-5 ml-3"></i>لوحة التحكم</a>
                <a href="orders.html" class="flex items-center px-4 py-2 text-gray-700 hover:bg-indigo-100 rounded-md"><i data-lucide="shopping-cart" class="w-5 h-5 ml-3"></i>الطلبات</a>
                <a href="users.html" class="flex items-center px-4 py-2 text-gray-700 hover:bg-indigo-100 rounded-md"><i data-lucide="users" class="w-5 h-5 ml-3"></i>المستخدمون</a>
                <a href="manage-blog.html" class="flex items-center px-4 py-2 text-gray-700 hover:bg-indigo-100 rounded-md"><i data-lucide="file-text" class="w-5 h-5 ml-3"></i>المدونة</a>
                <a href="manage-services.html" class="flex items-center px-4 py-2 text-gray-700 hover:bg-indigo-100 rounded-md"><i data-lucide="briefcase" class="w-5 h-5 ml-3"></i>الخدمات</a>
                <a href="support-log.html" class="flex items-center px-4 py-2 bg-indigo-600 text-white rounded-md"><i data-lucide="life-buoy" class="w-5 h-5 ml-3"></i>الدعم الفني</a>
                <a href="manage-reviews.html" class="flex items-center px-4 py-2 text-gray-700 hover:bg-indigo-100 rounded-md"><i data-lucide="star" class="w-5 h-5 ml-3"></i>المراجعات</a>
                <a href="settings.html" class="flex items-center px-4 py-2 text-gray-700 hover:bg-indigo-100 rounded-md"><i data-lucide="settings" class="w-5 h-5 ml-3"></i>الإعدادات</a>
            </nav>
        </aside>

        <!-- Main content area -->
        <div class="flex flex-col flex-1">
            <header class="flex items-center justify-between h-20 px-6 bg-white shadow-md flex-shrink-0">
                <h2 class="text-xl font-semibold text-gray-800">سجل الدعم الفني</h2>
                <div id="admin-info-placeholder"></div>
            </header>
            
            <main class="flex-1 flex overflow-hidden">
                <!-- Ticket List Panel -->
                <div class="w-full md:w-1/3 lg:w-1/4 flex flex-col bg-white border-l border-gray-200">
                    <div class="p-4 border-b"><input id="search-input" type="text" placeholder="ابحث بالاسم أو الموضوع..." class="w-full px-4 py-2 border rounded-lg"></div>
                    <div id="filter-buttons" class="p-2 flex justify-center gap-2 border-b">
                        <button data-status="all" class="filter-btn bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-sm">الكل</button>
                        <button data-status="open" class="filter-btn bg-gray-200 text-gray-700 px-3 py-1 rounded-full text-sm">مفتوح</button>
                        <button data-status="closed" class="filter-btn bg-gray-200 text-gray-700 px-3 py-1 rounded-full text-sm">مغلق</button>
                    </div>
                    <div id="ticket-list" class="flex-1 overflow-y-auto"></div>
                </div>

                <!-- Chat Panel -->
                <div id="chat-panel" class="flex-1 flex flex-col bg-gray-50">
                    <div id="no-chat-selected" class="flex flex-1 flex-col items-center justify-center text-center p-8">
                        <i data-lucide="inbox" class="w-16 h-16 text-gray-300 mb-4"></i>
                        <h3 class="text-xl font-bold text-gray-700">لم يتم تحديد تذكرة دعم</h3>
                        <p class="text-gray-500 mt-2">يرجى اختيار تذكرة من القائمة لعرض المحادثة.</p>
                    </div>

                    <div id="chat-area" class="hidden flex-1 flex flex-col">
                        <div class="flex items-center justify-between p-4 bg-white border-b">
                            <div id="user-info"></div>
                            <button id="close-ticket-btn" class="bg-red-600 text-white px-3 py-1 rounded-md text-sm hover:bg-red-700">إغلاق التذكرة</button>
                        </div>
                        <div id="messages-history" class="flex-1 p-4 overflow-y-auto"></div>
                        <div class="p-4 bg-white border-t">
                            <div class="bg-gray-100 p-3 rounded-lg mb-2">
                                <h4 class="text-sm font-bold mb-2">أدوات المشرف</h4>
                                <form id="order-search-form" class="flex items-center gap-2">
                                    <input type="text" id="order-id-input" placeholder="أدخل رقم الطلب KH-..." class="flex-grow px-2 py-1 border rounded-md text-sm">
                                    <button type="submit" class="bg-gray-700 text-white px-3 py-1 rounded-md text-sm hover:bg-gray-800">بحث</button>
                                </form>
                                <div id="order-details-card" class="mt-2 text-sm hidden"></div>
                                <button id="send-order-info-btn" class="w-full mt-2 bg-indigo-600 text-white py-1 rounded-md text-sm hover:bg-indigo-700 hidden">إرسال تفاصيل الطلب للمستخدم</button>
                            </div>
                            <form id="reply-form">
                                <textarea id="reply-message" class="w-full p-2 border rounded-md" placeholder="اكتب ردك هنا..." rows="3"></textarea>
                                <div class="flex justify-between items-center mt-2">
                                    <input type="file" id="reply-attachment">
                                    <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">إرسال الرد</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="../auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            // After
const API_URL = "https://orders-worker.radwanyhassan75.workers.dev/api/admin";
            let allTickets = [];
            let currentTicketId = null;
            let currentOrderDetailsText = '';

            const ticketListEl = document.getElementById('ticket-list');
            const noChatSelectedEl = document.getElementById('no-chat-selected');
            const chatAreaEl = document.getElementById('chat-area');
            const userInfoEl = document.getElementById('user-info');
            const messagesHistoryEl = document.getElementById('messages-history');
            const replyForm = document.getElementById('reply-form');
            const replyMessage = document.getElementById('reply-message');
            const replyAttachment = document.getElementById('reply-attachment');
            const closeTicketBtn = document.getElementById('close-ticket-btn');
            const orderSearchForm = document.getElementById('order-search-form');
            const orderIdInput = document.getElementById('order-id-input');
            const orderDetailsCard = document.getElementById('order-details-card');
            const sendOrderInfoBtn = document.getElementById('send-order-info-btn');
            const searchInput = document.getElementById('search-input');
            const filterButtons = document.querySelectorAll('.filter-btn');

            async function fetchTickets() {
                ticketListEl.innerHTML = '<p class="p-4 text-center text-gray-500">جاري تحميل التذاكر...</p>';
                try {
                    // After
const response = await fetch(`${API_URL}/tickets`);
                    if (!response.ok) throw new Error('تعذر تحميل التذاكر');
                    allTickets = await response.json();
                    filterAndRender();
                } catch (error) {
                    ticketListEl.innerHTML = `<p class="p-4 text-center text-red-500">${error.message}</p>`;
                }
            }

            function renderTicketList(tickets) {
                ticketListEl.innerHTML = '';
                if (tickets.length === 0) {
                    ticketListEl.innerHTML = '<p class="p-4 text-center text-gray-500">لا توجد تذاكر تطابق البحث.</p>';
                    return;
                }
                tickets.forEach(ticket => {
                    const item = document.createElement('div');
                    item.className = 'ticket-item p-4 border-b hover:bg-gray-50 cursor-pointer';
                    item.dataset.ticketId = ticket.id;
                    const statusClass = ticket.status === 'open' ? 'text-green-600' : 'text-gray-500';
                    item.innerHTML = `
                        <div class="flex justify-between items-center">
                            <h4 class="font-bold text-gray-800 truncate">${ticket.subject}</h4>
                            <span class="text-xs text-gray-500 flex-shrink-0">${new Date(ticket.updatedAt).toLocaleDateString('ar-EG')}</span>
                        </div>
                        <p class="text-sm text-gray-600">ID: ${ticket.id}</p>
                        <span class="text-xs font-semibold ${statusClass}">${ticket.status === 'open' ? 'مفتوح' : 'مغلق'}</span>
                    `;
                    item.addEventListener('click', () => selectTicket(ticket.id));
                    ticketListEl.appendChild(item);
                });
            }

            async function selectTicket(ticketId) {
                currentTicketId = ticketId;
                document.querySelectorAll('.ticket-item').forEach(el => {
                    el.classList.toggle('bg-indigo-50', el.dataset.ticketId === ticketId);
                });

                noChatSelectedEl.classList.add('hidden');
                chatAreaEl.classList.remove('hidden');
                chatAreaEl.classList.add('flex');
                messagesHistoryEl.innerHTML = '<p class="text-center p-8 text-gray-500">جاري تحميل المحادثة...</p>';

                try {
                    // After
const response = await fetch(`${API_URL}/tickets/${ticketId}`);
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error);
                    renderChat(data.ticket, data.messages);
                } catch (error) {
                    messagesHistoryEl.innerHTML = `<p class="text-center p-8 text-red-500">تعذر تحميل تفاصيل التذكرة.</p>`;
                }
            }
            
            async function renderChat(ticket, messages) {
                let userDisplayName = 'زائر';
                let userEmail = 'غير مسجل';
                if (ticket.userId !== 'guest-user') {
                    try {
                        const userResponse = await fetch(`${API_URL}/api/users/${ticket.userId}`);
                        if (userResponse.ok) {
                            const userData = await userResponse.json();
                            userDisplayName = userData.displayName || 'مستخدم مسجل';
                            userEmail = userData.email;
                        }
                    } catch (e) { console.error("Could not fetch user details"); }
                }
                
                userInfoEl.innerHTML = `
                    <div>
                        <h3 class="font-bold text-lg">${userDisplayName}</h3>
                        <p class="text-sm text-gray-500">${userEmail}</p>
                    </div>`;
                
                messagesHistoryEl.innerHTML = '';
                messages.forEach(msg => appendMessage(msg));
                messagesHistoryEl.scrollTop = messagesHistoryEl.scrollHeight;
                
                const isClosed = ticket.status === 'closed';
                replyMessage.disabled = isClosed;
                replyAttachment.disabled = isClosed;
                replyForm.querySelector('button[type="submit"]').disabled = isClosed;
                closeTicketBtn.disabled = isClosed;
                closeTicketBtn.textContent = isClosed ? 'تم الإغلاق' : 'إغلاق التذكرة';
                replyMessage.placeholder = isClosed ? 'تم إغلاق هذه المحادثة.' : 'اكتب ردك هنا...';
            }

            function appendMessage(msg) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.sender}`;
                messageDiv.innerHTML = `
                    <div class="p-3 rounded-lg ${msg.sender === 'admin' ? 'bg-indigo-500 text-white' : 'bg-gray-200'}">
                        <p class="text-sm">${(msg.message || '').replace(/\n/g, '<br>')}</p>
                        ${msg.attachmentUrl ? `<a href="${msg.attachmentUrl}" target="_blank" class="text-sm font-bold mt-2 inline-block hover:underline ${msg.sender === 'admin' ? 'text-indigo-200' : 'text-indigo-600'}">عرض المرفق</a>` : ''}
                    </div>
                    <div class="text-xs text-gray-400 mt-1 px-2 ${msg.sender === 'admin' ? 'text-left' : 'text-right'}">${new Date(msg.createdAt).toLocaleString('ar-EG')}</div>
                `;
                messagesHistoryEl.appendChild(messageDiv);
                messagesHistoryEl.scrollTop = messagesHistoryEl.scrollHeight;
            }

            replyForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const messageText = replyMessage.value.trim();
                const attachmentFile = replyAttachment.files[0];
                if (!messageText && !attachmentFile) return;

                const formData = new FormData();
                formData.append('sender', 'admin');
                formData.append('message', messageText);
                if (attachmentFile) formData.append('attachment', attachmentFile);

                try {
                    const response = await fetch(`${API_URL}/api/tickets/${currentTicketId}/messages`, {
                        method: 'POST',
                        body: formData
                    });
                    const newMsg = await response.json();
                    if (!response.ok) throw new Error(newMsg.error || 'فشل إرسال الرسالة.');

                    appendMessage(newMsg);
                    replyMessage.value = '';
                    replyAttachment.value = '';
                    await loadAllTickets(); // Refresh ticket list to show updated time
                } catch (error) {
                    alert(`خطأ: ${error.message}`);
                }
            });

            closeTicketBtn.addEventListener('click', async () => {
                if (!confirm('هل أنت متأكد من أنك تريد إغلاق هذه التذكرة؟')) return;
                try {
                    await fetch(`${API_URL}/api/tickets/${currentTicketId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: 'closed' })
                    });
                    await selectTicket(currentTicketId);
                    await loadAllTickets();
                } catch (error) {
                    alert(`خطأ: ${error.message}`);
                }
            });
            
            orderSearchForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const orderId = orderIdInput.value.trim();
                if (!orderId) return;
                
                orderDetailsCard.classList.remove('hidden');
                orderDetailsCard.innerHTML = 'جاري البحث...';
                sendOrderInfoBtn.classList.add('hidden');

                try {
                    const response = await fetch(`${API_URL}/api/orders/${orderId}`);
                    const order = await response.json();
                    if (!response.ok) throw new Error(order.error || 'لم يتم العثور على الطلب.');

                    currentOrderDetailsText = `تفاصيل الطلب: ${order.id}\nالخدمة: ${order.serviceName}\nالحالة: ${order.status}\nالسعر: ${order.price} د.م.`;
                    orderDetailsCard.innerHTML = currentOrderDetailsText.replace(/\n/g, '<br>');
                    sendOrderInfoBtn.classList.remove('hidden');
                } catch (error) {
                    orderDetailsCard.innerHTML = `<span class="text-red-500">${error.message}</span>`;
                }
            });

            sendOrderInfoBtn.addEventListener('click', () => {
                if (currentOrderDetailsText) {
                    replyMessage.value += (replyMessage.value ? '\n\n' : '') + currentOrderDetailsText;
                    orderDetailsCard.classList.add('hidden');
                    sendOrderInfoBtn.classList.add('hidden');
                    orderIdInput.value = '';
                }
            });

            function filterAndRender() {
                const searchTerm = searchInput.value.toLowerCase();
                const activeFilter = document.querySelector('.filter-btn.bg-indigo-100').dataset.status;
                let filteredTickets = allTickets;

                if (activeFilter !== 'all') {
                    filteredTickets = allTickets.filter(t => t.status === activeFilter);
                }

                if (searchTerm) {
                    filteredTickets = filteredTickets.filter(t => 
                        (t.subject && t.subject.toLowerCase().includes(searchTerm)) ||
                        (t.id && t.id.toLowerCase().includes(searchTerm))
                    );
                }
                renderTicketList(filteredTickets);
            }

            filterButtons.forEach(button => {
                button.addEventListener('click', () => {
                    filterButtons.forEach(btn => {
                        btn.classList.replace('bg-indigo-100', 'bg-gray-200');
                        btn.classList.replace('text-indigo-700', 'text-gray-700');
                    });
                    button.classList.replace('bg-gray-200', 'bg-indigo-100');
                    button.classList.replace('text-gray-700', 'text-indigo-700');
                    filterAndRender();
                });
            });
            searchInput.addEventListener('input', filterAndRender);
            
            fetchTickets();
        });
    </script>
</body>
</html>
