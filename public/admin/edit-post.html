<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>إدارة المقال - لوحة التحكم</title>
    
    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Cairo -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- TinyMCE Rich Text Editor -->
    <script src="https://cdn.tiny.cloud/1/zpmhp4q38jsl57jo0umqh4phj26r1u24ihzl99ks14x6j7dt/tinymce/6/tinymce.min.js"></script>
    
    <style>
        body, input, textarea, select, button { 
            font-family: 'Cairo', 'Tahoma', 'Arial', sans-serif; 
        }
        .tox-fullscreen { 
            z-index: 10000 !important; 
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        #notification {
            position: fixed;
            bottom: -100px; /* Start off-screen */
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            z-index: 10001;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s, bottom 0.4s;
        }
        #notification.show {
            opacity: 1;
            visibility: visible;
            bottom: 20px; /* Slide in */
        }
        /* Hide content until authorized */
        #dashboard-content {
            display: none;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-700">

    <div id="dashboard-content" class="h-screen md:flex flex-row-reverse">
        <aside class="flex flex-col w-64 bg-white border-l border-slate-200">
            <div class="flex items-center justify-center h-20 border-b border-slate-200">
                <h1 class="text-2xl font-bold text-indigo-600">لوحة تحكم خدماتك</h1>
            </div>
            <nav class="flex-1 px-4 py-6 space-y-2">
                <a href="dashboard.html" class="flex items-center px-4 py-3 text-slate-600 hover:bg-indigo-50 hover:text-indigo-600 rounded-lg transition-colors duration-200">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                    <span class="mr-3">لوحة التحكم</span>
                </a>
                <a href="orders.html" class="flex items-center px-4 py-3 text-slate-600 hover:bg-indigo-50 hover:text-indigo-600 rounded-lg transition-colors duration-200">
                    <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                    <span class="mr-3">الطلبات</span>
                </a>
                <a href="users.html" class="flex items-center px-4 py-3 text-slate-600 hover:bg-indigo-50 hover:text-indigo-600 rounded-lg transition-colors duration-200">
                    <i data-lucide="users" class="w-5 h-5"></i>
                    <span class="mr-3">المستخدمون</span>
                </a>
                <a href="manage-blog.html" class="flex items-center px-4 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md">
                    <i data-lucide="file-text" class="w-5 h-5"></i>
                    <span class="mr-3">المدونة</span>
                </a>
                <a href="support-log.html" class="flex items-center px-4 py-3 text-slate-600 hover:bg-indigo-50 hover:text-indigo-600 rounded-lg transition-colors duration-200">
                    <i data-lucide="life-buoy" class="w-5 h-5"></i>
                    <span class="mr-3">الدعم الفني</span>
                </a>
                <a href="settings.html" class="flex items-center px-4 py-3 text-slate-600 hover:bg-indigo-50 hover:text-indigo-600 rounded-lg transition-colors duration-200">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                    <span class="mr-3">الإعدادات</span>
                </a>
            </nav>
        </aside>

        <div class="flex flex-col flex-1 overflow-y-auto">
            <header class="flex items-center justify-between h-20 px-8 bg-white border-b border-slate-200 sticky top-0 z-10">
                <div>
                    <h2 class="text-xl font-semibold text-slate-800">إدارة المدونة</h2>
                    <p id="page-title" class="text-sm text-slate-500">إنشاء مقال جديد</p>
                </div>
                <a href="manage-blog.html" class="bg-slate-100 text-slate-700 px-4 py-2 rounded-lg hover:bg-slate-200 transition-colors duration-200 flex items-center font-medium"><i data-lucide="arrow-right" class="w-4 h-4 ml-2"></i><span>العودة إلى قائمة المقالات</span></a>
            </header>
            
            <main class="p-6 md:p-8">
                <form id="post-form" class="space-y-8">
                    <div class="bg-white p-8 rounded-xl shadow-sm border border-slate-200">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="title" class="block text-sm font-medium text-slate-600 mb-2">عنوان المقال</label>
                                <input type="text" id="title" placeholder="اكتب عنوانًا واضحًا وجذابًا هنا" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-500 transition" required>
                            </div>
                            <div>
                                <label for="slug" class="block text-sm font-medium text-slate-600 mb-2">الرابط الدائم (Slug)</label>
                                <input type="text" id="slug" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg bg-slate-50 focus:ring-2 focus:ring-indigo-300 focus:border-indigo-500 transition ltr text-left" required>
                                <p class="text-xs text-slate-500 mt-2">سيتم إنشاؤه تلقائيًا من العنوان.</p>
                            </div>
                        </div>
                        <div class="mt-6">
                            <label for="content-editor" class="block text-sm font-medium text-slate-600 mb-2">محتوى المقال</label>
                            <textarea id="content-editor" class="w-full"></textarea>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 bg-white p-8 rounded-xl shadow-sm border border-slate-200 space-y-6">
                            <h3 class="text-lg font-semibold text-slate-800 border-b pb-3 mb-4 flex items-center"><i data-lucide="search" class="w-5 h-5 ml-2 text-indigo-500"></i>تحسينات محركات البحث (SEO)</h3>
                            <div>
                                <label for="meta_title" class="block text-sm font-medium text-slate-600 mb-2">عنوان SEO (Meta Title)</label>
                                <input type="text" id="meta_title" placeholder="عنوان يظهر في جوجل (60 حرفًا كحد أقصى)" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-500 transition" maxlength="60">
                            </div>
                            <div>
                                <label for="meta_description" class="block text-sm font-medium text-slate-600 mb-2">وصف SEO (Meta Description)</label>
                                <textarea id="meta_description" rows="3" placeholder="وصف موجز وجذاب للمقال (160 حرفًا كحد أقصى)" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-500 transition" maxlength="160"></textarea>
                            </div>
                        </div>
                        <div class="bg-white p-8 rounded-xl shadow-sm border border-slate-200 space-y-6">
                            <h3 class="text-lg font-semibold text-slate-800 border-b pb-3 mb-4 flex items-center"><i data-lucide="settings-2" class="w-5 h-5 ml-2 text-indigo-500"></i>خيارات النشر</h3>
                            <div>
                                <label for="featured_image_url" class="block text-sm font-medium text-slate-600 mb-2">رابط الصورة البارزة</label>
                                <input type="url" id="featured_image_url" placeholder="https://example.com/image.jpg" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-500 transition">
                            </div>
                            <div>
                                <label for="tags" class="block text-sm font-medium text-slate-600 mb-2">الوسوم (افصل بفاصلة ,)</label>
                                <input type="text" id="tags" placeholder="أخبار, تحديثات, خدمات" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-500 transition">
                            </div>
                            <div>
                                <label for="status" class="block text-sm font-medium text-slate-600 mb-2">حالة المقال</label>
                                <select id="status" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-300 focus:border-indigo-500 transition bg-white">
                                    <option value="draft">مسودة</option>
                                    <option value="published">منشور</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="pt-4 flex justify-start">
                        <button type="submit" class="bg-indigo-600 text-white font-semibold px-8 py-3 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300 transition-all duration-300 flex items-center shadow-lg hover:shadow-xl disabled:bg-indigo-400">
                            <i data-lucide="save" class="w-5 h-5 ml-2"></i>
                            <span id="submit-button-text">حفظ المقال</span>
                        </button>
                    </div>
                </form>
            </main>
        </div>
    </div>
    
    <div id="notification"></div>

    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // =================================================================
            // START: COMBINED SCRIPT (auth.js + admin-auth.js + page logic)
            // =================================================================

            // --- Part 0: Firebase Initialization ---
            const firebaseConfig = {
                apiKey: "AIzaSyBfuVxOgengj2b1JBdt9V3u5WAnyYWsd78",
                authDomain: "khadamatukdigital.firebaseapp.com",
                projectId: "khadamatukdigital",
                storageBucket: "khadamatukdigital.appspot.com",
                messagingSenderId: "690661888019",
                appId: "1:690661888019:web:8770076b69beda7d2d6fe6",
            };

            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }

            // --- Part 1: Admin Authentication Logic ---
            const ADMIN_UIDS = ["mxNwy7nqQBRP5K582gi21TrIBW73"];

            function denyAccess() {
                console.error("الوصول مرفوض. المستخدم ليس مديراً أو لم يسجل دخوله.");
                document.body.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #dc3545; font-family: 'Cairo', sans-serif;">
                        <h1 style="font-size: 2rem; margin-top: 20px;">الوصول مرفوض</h1>
                        <p style="font-size: 1.1rem;">أنت غير مصرح لك بالوصول إلى هذه الصفحة. سيتم إعادة توجيهك الآن.</p>
                    </div>`;
                // ✅✅✅ THE FIX - PART 1 ✅✅✅
                // Using a relative path `../../login.html` to correctly navigate out of the /public/admin/ directory.
                setTimeout(() => { window.location.href = '../../login.html'; }, 4000);
            }

            function grantAccess() {
                console.log("تم منح الوصول. مرحباً أيها المدير! جارٍ تهيئة الصفحة...");
                const dashboardContent = document.getElementById('dashboard-content');
                if (dashboardContent) {
                    dashboardContent.style.display = 'flex';
                }
                initializePage();
            }

            function checkAdminAuth() {
                console.log("1. بدء عملية التحقق من هوية المدير...");
                if (typeof firebase === 'undefined' || typeof firebase.auth === 'undefined') {
                    console.error("خطأ فادح: مكتبة Firebase لم يتم تحميلها.");
                    denyAccess();
                    return;
                }
                firebase.auth().onAuthStateChanged(user => {
                    console.log("2. Firebase أعطى تحديثًا لحالة المستخدم...");
                    if (user) {
                        console.log("3. تم العثور على مستخدم مسجل دخوله. UID:", user.uid);
                        if (ADMIN_UIDS.includes(user.uid)) {
                            console.log("4. نتيجة التحقق: UID متطابق. هذا المستخدم هو مدير.");
                            grantAccess();
                        } else {
                            console.error("4. نتيجة التحقق: UID غير متطابق. هذا المستخدم ليس مديرًا.");
                            denyAccess();
                        }
                    } else {
                        console.error("3. لم يتم العثور على أي مستخدم مسجل دخوله. إعادة التوجيه لصفحة الدخول...");
                        // ✅✅✅ THE FIX - PART 2 ✅✅✅
                        // Correctly encodes the full redirect path and uses a relative path to find login.html
                        const redirectPath = window.location.pathname + window.location.search;
                        const redirectUrl = `../../login.html?redirect=${encodeURIComponent(redirectPath)}`;
                        window.location.href = redirectUrl;
                    }
                });
            }

            // --- Part 2: Page-Specific Logic (No changes needed here) ---
            function initializePage() {
                const API_URL = "https://orders-worker.radwanyhassan75.workers.dev";
                
                lucide.createIcons();

                const urlParams = new URLSearchParams(window.location.search);
                const postId = urlParams.get('id');
                const isEditMode = !!postId;

                const pageTitleElement = document.getElementById('page-title');
                const submitButtonText = document.getElementById('submit-button-text');
                const postForm = document.getElementById('post-form');
                const titleInput = document.getElementById('title');
                const slugInput = document.getElementById('slug');

                async function loadPostForEditing() {
                    if (!isEditMode) return;

                    pageTitleElement.textContent = 'تعديل المقال';
                    submitButtonText.textContent = 'تحديث المقال';

                    try {
                        const response = await fetch(`${API_URL}/api/admin/posts/${postId}`);
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({ error: 'فشل في قراءة استجابة الخادم' }));
                            throw new Error(`فشل جلب البيانات. الحالة: ${response.status}. السبب: ${errorData.error}`);
                        }
                        const post = await response.json();
                        if (!post || typeof post !== 'object') {
                            throw new Error('بيانات المقال المستلمة غير صالحة.');
                        }

                        titleInput.value = post.title || '';
                        slugInput.value = post.slug || '';
                        document.getElementById('meta_title').value = post.meta_title || '';
                        document.getElementById('meta_description').value = post.meta_description || '';
                        document.getElementById('featured_image_url').value = post.featured_image_url || '';
                        
                        let tagsValue = '';
                        if (post.tags) {
                            try {
                                const parsedTags = JSON.parse(post.tags);
                                if (Array.isArray(parsedTags)) {
                                    tagsValue = parsedTags.join(', ');
                                }
                            } catch (e) {
                                tagsValue = post.tags;
                            }
                        }
                        document.getElementById('tags').value = tagsValue;

                        document.getElementById('status').value = post.status || 'draft';
                        
                        const editor = tinymce.get('content-editor');
                        if (editor) {
                            editor.setContent(post.content || '');
                        }
                    } catch (error) {
                        console.error("======================================================");
                        console.error("حدث خطأ جسيم أثناء محاولة جلب بيانات المقال للتعديل.");
                        console.error("الدالة المتأثرة: loadPostForEditing()");
                        console.error("السبب المحتمل:", error.message);
                        console.error("تفاصيل الخطأ الكاملة:", error);
                        console.error("======================================================");
                        showNotification('خطأ في تحميل بيانات المقال. تحقق من الكونسول لمزيد من التفاصيل.', 'error');
                    }
                }

                tinymce.init({
                    selector: '#content-editor',
                    plugins: 'advlist autolink lists link image charmap searchreplace visualblocks code fullscreen insertdatetime media table code help wordcount directionality',
                    toolbar: 'undo redo | formatselect | bold italic backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | help | ltr rtl',
                    directionality: 'rtl',
                    language: 'ar',
                    height: 500,
                    menubar: true,
                    content_style: 'body { font-family:Cairo,Arial,sans-serif; font-size:16px }',
                    setup: function (editor) {
                        editor.on('init', function () {
                            loadPostForEditing();
                        });
                    }
                });

                function generateSlug(text) {
                    if (!text) return '';
                    return text.toString().toLowerCase()
                        .replace(/\s+/g, '-')
                        .replace(/[^\u0600-\u06FF\w\-]+/g, '')
                        .replace(/\-\-+/g, '-')
                        .replace(/^-+/, '')
                        .replace(/-+$/, '');
                }

                titleInput.addEventListener('keyup', () => slugInput.value = generateSlug(titleInput.value));

                postForm.addEventListener('submit', async function(event) {
                    event.preventDefault(); 
                    
                    const submitButton = postForm.querySelector('button[type="submit"]');
                    const content = tinymce.get('content-editor').getContent();
                    if (!titleInput.value || !content) {
                        showNotification('يرجى ملء حقلي العنوان والمحتوى.', 'error');
                        return;
                    }

                    const postData = {
                        title: titleInput.value,
                        slug: slugInput.value,
                        content: content,
                        meta_title: document.getElementById('meta_title').value,
                        meta_description: document.getElementById('meta_description').value,
                        featured_image_url: document.getElementById('featured_image_url').value,
                        tags: document.getElementById('tags').value.split(',').map(tag => tag.trim()).filter(tag => tag),
                        status: document.getElementById('status').value,
                    };

                    submitButton.disabled = true;
                    submitButtonText.textContent = isEditMode ? 'جارٍ التحديث...' : 'جارٍ الحفظ...';

                    try {
                        const url = isEditMode ? `${API_URL}/api/admin/posts/${postId}` : `${API_URL}/api/admin/posts`;
                        const method = isEditMode ? 'PUT' : 'POST';

                        const response = await fetch(url, {
                            method: method,
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(postData),
                        });

                        if (!response.ok) {
                            const errorResult = await response.json().catch(() => ({}));
                            throw new Error(errorResult.error || `فشل الخادم. الحالة: ${response.status}`);
                        }

                        showNotification(isEditMode ? 'تم تحديث المقال بنجاح!' : 'تم حفظ المقال بنجاح!', 'success');
                        
                        setTimeout(() => {
                            window.location.href = 'manage-blog.html';
                        }, 1500);

                    } catch (error) {
                        console.error('Error saving post:', error);
                        showNotification('حدث خطأ أثناء الحفظ: ' + error.message, 'error');
                    } finally {
                        submitButton.disabled = false;
                        submitButtonText.textContent = isEditMode ? 'تحديث المقال' : 'حفظ المقال';
                    }
                });

                function showNotification(message, type = 'success') {
                    const notification = document.getElementById('notification');
                    notification.textContent = message;
                    
                    notification.className = '';
                    notification.classList.add('show');
                    if (type === 'success') {
                        notification.classList.add('bg-green-500');
                    } else {
                        notification.classList.add('bg-red-500');
                    }
                    
                    setTimeout(() => {
                        notification.classList.remove('show');
                    }, 3000);
                }
            }

            // --- Part 3: Start the Authentication Process ---
            checkAdminAuth();

        });
    </script>
    
</body>
</html>
