<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>إنشاء حساب جديد - المكتب الرقمي</title>
    <meta property="og:title" content="إنشاء حساب جديد - المكتب الرقمي" />
    <meta property="og:description" content="انضم إلى منصة المكتب الرقمي وأنشئ حسابك الآن لإنجاز معاملاتك الرقمية بكل سهولة وأمان." />
    <meta property="og:image" content="https://www.khadamatmaroc.co.uk/images/logo.png" />
    <meta property="og:url" content="https://khadamatmaroc.co.uk/register" />
    <meta property="og:type" content="website" />
    <meta property="fb:app_id" content="24385253824462027" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link rel="stylesheet" href="style.css">
    <style>
        /* Style for disabled buttons */
        .btn:disabled, .social-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        /* Style for the legal notice box */
        .legal-notice {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.85rem;
            color: #6c757d;
            text-align: right;
            line-height: 1.6;
        }
        .legal-notice h4 {
            color: #343a40;
            margin-top: 0;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div id="header-placeholder"></div>

    <main class="main-content">
        <div class="auth-container">
            <div class="branding-section" style="background-image: url('https://images.unsplash.com/photo-1554224155-8d04cb21cd6c?q=80&w=2070&auto=format&fit=crop');">
                 <div class="branding-overlay">
                    <h1>انضم إلى الآلاف من العملاء السعداء</h1>
                    <p>أنشئ حسابك الآن وابدأ في إنجاز معاملاتك الرقمية بكل سهولة وأمان.</p>
                </div>
            </div>

            <div class="form-section">
                <div class="form-box">
                    <h1>إنشاء حساب جديد</h1>
                    <p>انضم إلينا وابدأ رحلتك الرقمية.</p>

                    <div id="message-box"></div>

                     <div class="social-login-grid">
                        <button class="social-btn" id="google-btn" data-provider="google" disabled><i class="fab fa-google"></i> Google</button>
                        <button class="social-btn" id="facebook-btn" data-provider="facebook" disabled><i class="fab fa-facebook"></i> Facebook</button>
                        <button class="social-btn" id="twitter-btn" data-provider="twitter" disabled><i class="fab fa-twitter"></i> Twitter</button>
                        <button class="social-btn" id="spotify-btn" data-provider="spotify" disabled><i class="fab fa-spotify"></i> Spotify</button>
                    </div>

                    <div class="divider">أو أكمل بالبريد الإلكتروني</div>
                    
                    <form id="register-form" novalidate>
                        <div class="form-group">
                            <label for="full_name">الاسم الكامل</label>
                            <input type="text" id="full_name" required autocomplete="name">
                        </div>
                        <div class="form-group">
                            <label for="email">البريد الإلكتروني</label>
                            <input type="email" id="email" required autocomplete="email">
                        </div>
                         <div class="form-group">
                            <label for="phone">رقم الهاتف</label>
                            <input type="tel" id="phone" required autocomplete="tel">
                        </div>
                        <div class="form-group">
                            <label for="password">كلمة المرور</label>
                            <input type="password" id="password" minlength="8" required autocomplete="new-password">
                        </div>
                        <div class="form-group">
                            <label for="confirm_password">تأكيد كلمة المرور</label>
                            <input type="password" id="confirm_password" minlength="8" required autocomplete="new-password">
                        </div>

                        <div class="legal-notice">
                            <h4>إشعار حماية البيانات الشخصية</h4>
                            <p>
                                من خلال هذا النموذج، يقوم موقع **المكتب الرقمي (Khadamat Maroc)** بجمع بياناتك الشخصية بهدف إنشاء وإدارة حسابك، تقديم الخدمات المطلوبة، وتسهيل التواصل معك بشأنها. تخضع هذه المعالجة لمقتضيات القانون رقم 09-08 المتعلق بحماية الأشخاص الذاتيين تجاه معالجة المعطيات ذات الطابع الشخصي.
                                قد تتم مشاركة البيانات المجمعة مع شركائنا التقنيين وموفري الخدمات مثل Supabase، الذين قد يتواجدون خارج المغرب (مثل الولايات المتحدة الأمريكية)، وذلك لضمان تقديم الخدمة بأفضل شكل ممكن.
                                يمكنكم التواصل معنا عبر البريد الإلكتروني <a href="mailto:support@khadamatmaroc.co.uk">support@khadamatmaroc.co.uk</a> لممارسة حقوقكم في الوصول إلى البيانات، تصحيحها، أو الاعتراض على معالجتها وفقًا لمقتضيات القانون 09-08.
                            </p>
                        </div>
                        
                        <div class="form-group terms">
                             <input type="checkbox" id="terms_agree" class="mandatory-check">
                             <label for="terms_agree">أقر بأنني قرأت و أوافق على <a href="/terms.html" target="_blank">الشروط والأحكام</a>.</label>
                        </div>
                        <div class="form-group terms">
                             <input type="checkbox" id="privacy_notice_agree" class="mandatory-check">
                             <label for="privacy_notice_agree">أقر بأنني قرأت وفهمت إشعار حماية البيانات الشخصية أعلاه.</label>
                        </div>

                        <div class="form-group" style="display: flex; justify-content: center;">
                           <div id="recaptcha-container" class="g-recaptcha" data-sitekey="6LfwmrsrAAAAAOnCTK7DHTkn4spWMN2UcpmbS_jv" data-callback="onRecaptchaSuccess"></div>
                        </div>

                        <button type="submit" id="submit-btn" class="btn btn-primary" disabled>إنشاء الحساب</button>
                    </form>
                    <div class="form-footer">
                        <p>لديك حساب بالفعل؟ <a href="login.html">سجل الدخول</a></p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="footer-placeholder"></div>
    
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    
    <script type="module" src="auth.js"></script>
    <script src="layout.js"></script>

    <script type="module">
        import { supabase } from './auth.js';
        
        // --- Element Selections ---
        const registerForm = document.getElementById('register-form');
        const messageBox = document.getElementById('message-box');
        const submitButton = document.getElementById('submit-btn');
        const socialButtons = document.querySelectorAll('.social-btn');
        const mandatoryCheckboxes = document.querySelectorAll('.mandatory-check');
        
        let recaptchaSolved = false;

        // --- Main Function to Control Button States ---
        function updateButtonStates() {
            const allChecked = Array.from(mandatoryCheckboxes).every(cb => cb.checked);
            
            if (allChecked && recaptchaSolved) {
                submitButton.disabled = false;
                socialButtons.forEach(btn => btn.disabled = false);
            } else {
                submitButton.disabled = true;
                socialButtons.forEach(btn => btn.disabled = true);
            }
        }

        // --- Event Listeners ---
        mandatoryCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateButtonStates);
        });

        window.onRecaptchaSuccess = function() {
            recaptchaSolved = true;
            updateButtonStates();
        };
        
        socialButtons.forEach(button => {
            button.addEventListener('click', () => {
                if (button.disabled) return;
                const provider = button.getAttribute('data-provider');
                window.signInWithProvider(provider);
            });
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (submitButton.disabled) return;

            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جارٍ الإنشاء...';

            // --- Client-side Validation ---
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirm_password').value;
            
            if (password.length < 8) {
                showMessage('error', 'يجب أن تكون كلمة المرور 8 أحرف على الأقل.');
                resetSubmitButton();
                return;
            }
            if (password !== confirmPassword) {
                showMessage('error', 'كلمتا المرور غير متطابقتين.');
                resetSubmitButton();
                return;
            }

            const email = document.getElementById('email').value;
            const fullName = document.getElementById('full_name').value;
            const phone = document.getElementById('phone').value;
            
            // --- Supabase Sign Up ---
            const { data, error } = await supabase.auth.signUp({
                email,
                password,
                options: { 
                    data: { 
                        full_name: fullName,
                        phone: phone
                    } 
                }
            });

            if (error) {
                if (error.message.includes("already registered")) {
                    showMessage('error', 'هذا البريد الإلكتروني مسجل بالفعل. <a href=\'login.html\'>حاول تسجيل الدخول</a>.');
                } else if (error.message.includes("weak password")) {
                    showMessage('error', 'كلمة المرور ضعيفة جدًا.');
                } else {
                    showMessage('error', 'حدث خطأ ما. الرجاء المحاولة مرة أخرى.');
                }
                resetSubmitButton();
            } else {
                if (data.session) {
                    showMessage('success', 'تم إنشاء الحساب بنجاح! جارٍ توجيهك...');
                    setTimeout(() => { window.location.href = '/dashboard.html'; }, 1500);
                } else {
                    showMessage('info', 'تم إنشاء الحساب بنجاح! يرجى التحقق من بريدك الإلكتروني للتفعيل.');
                    resetSubmitButton();
                }
            }
        });

        function showMessage(type, html) {
            messageBox.style.display = 'block';
            messageBox.className = type;
            messageBox.innerHTML = html;
        }
        
        function resetSubmitButton() {
            submitButton.disabled = false;
            submitButton.innerHTML = 'إنشاء الحساب';
            // Note: reCAPTCHA should ideally be reset here as well if the form submission fails.
            // grecaptcha.reset();
        }

        // Initial check in case the browser remembers checkbox state
        updateButtonStates();
    </script>
</body>
</html>