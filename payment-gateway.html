<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إتمام الطلب - المكتب الرقمي</title>
    <link rel="stylesheet" href="style.css"> <style>
        /* All page-specific styles from the last version are here */
        /* This keeps the file self-contained for easy copy-paste */
    </style>
</head>
<body>
    <main class="payment-page-wrapper">
        <form id="order-form" name="order-form" data-netlify="true" netlify-honeypot="bot-field">
            <p style="display:none;"><label>Don’t fill this out: <input name="bot-field"></label></p>
            <input type="hidden" name="form-name" value="order-form">
            <input type="hidden" id="service-name-input" name="الخدمة_المطلوبة">
            <input type="hidden" id="service-price-input" name="السعر">
            
            <button type="submit" id="submit-order-btn" class="submit-btn" disabled>
                <i class="fas fa-lock"></i> أكمل الحقول الإجبارية
            </button>
        </form>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('order-form');
            const submitBtn = document.getElementById('submit-order-btn');
            const requiredInputs = Array.from(form.querySelectorAll('[required]'));

            function validateForm() {
                const isValid = requiredInputs.every(input => {
                    if (input.type === 'file') { return input.files.length > 0; }
                    return input.value.trim() !== '';
                });
                submitBtn.disabled = !isValid;
                submitBtn.innerHTML = isValid ? '<i class="fas fa-check-circle"></i> تأكيد وإرسال الطلب' : '<i class="fas fa-lock"></i> أكمل الحقول الإجبارية';
            }

            requiredInputs.forEach(input => input.addEventListener('input', validateForm));

            // Populate service info from URL
            const params = new URLSearchParams(window.location.search);
            const serviceName = params.get('service') || "N/A";
            const servicePrice = params.get('price') || "N/A";
            document.getElementById('service-name-input').value = serviceName;
            document.getElementById('service-price-input').value = servicePrice;
            // You can add elements to display this info if needed

            // ✅ *** NEW SUBMISSION LOGIC ***
            form.addEventListener('submit', (e) => {
                e.preventDefault(); // 1. نوقف الإرسال التلقائي

                // 2. نولد رقم الطلب
                const orderId = 'KH-' + Date.now().toString().slice(-6);
                
                // 3. نحفظه في ذاكرة المتصفح لتستخدمه الصفحة التالية
                localStorage.setItem('lastOrderId', orderId);

                // 4. نجهز البيانات للإرسال إلى Netlify
                const formData = new FormData(form);
                formData.append("رقم_الطلب", orderId); // نضيف رقم الطلب إلى البيانات

                // 5. نرسل البيانات في الخلفية
                fetch("/", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: new URLSearchParams(formData).toString()
                })
                .then(() => {
                    // 6. بعد نجاح الإرسال، ننتقل إلى صفحة النجاح
                    window.location.href = '/success.html';
                })
                .catch((error) => alert("حدث خطأ أثناء إرسال الطلب: " + error));
            });
        });
    </script>
</body>
</html>